<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Mock functions in a package. â€” with_mock â€¢ testthat</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Mock functions in a package. â€” with_mock" />
<meta property="og:description" content="
with_mock() and local_mock() are superseded in favour of the more
rigorous techniques found in the mockr
and mockery packages.
Mocking allows you to temporary replace the implementation of functions
within a package, which useful for testing code that relies on functions
that are slow, have unintended side effects or access resources that may
not be available when testing.
This works by using some C code to temporarily modify the mocked function
in place. On exit, all functions are restored to their previous state.
This is somewhat abusive of R's internals so use with care. In particular,
functions in base packages cannot be mocked; to work aroud you'll need to
make a wrapper function in your own package.." />
<meta property="og:image" content="https://testthat.r-lib.org/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>


  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">testthat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.99.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/custom-expectation.html">Custom expectations</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Running tests in parallel</a>
    </li>
    <li>
      <a href="../articles/skipping.html">Skipping tests</a>
    </li>
    <li>
      <a href="../articles/snapshotting.html">Snapshot tests</a>
    </li>
    <li>
      <a href="../articles/test-fixtures.html">Test fixtures</a>
    </li>
    <li>
      <a href="../articles/third-edition.html">testthat 3e</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Releases</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/r-lib/testthat/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Mock functions in a package.</h1>
    <small class="dont-index">Source: <a href='https://github.com/r-lib/testthat/blob/master/R/mock.R'><code>R/mock.R</code></a></small>
    <div class="hidden name"><code>with_mock.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><a href='https://www.tidyverse.org/lifecycle/#superseded'><img src='figures/lifecycle-superseded.svg' alt='Superseded lifecycle'></a></p>
<p><code>with_mock()</code> and <code>local_mock()</code> are superseded in favour of the more
rigorous techniques found in the <a href='https://krlmlr.github.io/mockr/'>mockr</a>
and <a href='https://github.com/r-lib/mockery#mockery'>mockery</a> packages.</p>
<p>Mocking allows you to temporary replace the implementation of functions
within a package, which useful for testing code that relies on functions
that are slow, have unintended side effects or access resources that may
not be available when testing.</p>
<p>This works by using some C code to temporarily modify the mocked function
<em>in place</em>. On exit, all functions are restored to their previous state.
This is somewhat abusive of R's internals so use with care. In particular,
functions in base packages cannot be mocked; to work aroud you'll need to
make a wrapper function in your own package..</p>
    </div>

    <pre class="usage"><span class='fu'>with_mock</span>(<span class='no'>...</span>, <span class='kw'>.env</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ns-topenv.html'>topenv</a></span>())

<span class='fu'>local_mock</span>(<span class='no'>...</span>, <span class='kw'>.env</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ns-topenv.html'>topenv</a></span>(), <span class='kw'>.local_envir</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sys.parent.html'>parent.frame</a></span>())</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>...</th>
      <td><p>named parameters redefine mocked functions, unnamed parameters
will be evaluated after mocking the functions</p></td>
    </tr>
    <tr>
      <th>.env</th>
      <td><p>the environment in which to patch the functions,
defaults to the top-level environment.  A character is interpreted as
package name.</p></td>
    </tr>
    <tr>
      <th>.local_env</th>
      <td><p>Environment in which to add exit hander.
For expert use only.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>The result of the last unnamed parameter</p>
    <h2 class="hasAnchor" id="-rd-edition"><a class="anchor" href="#-rd-edition"></a>3rd edition</h2>

    

<p><img src='figures/lifecycle-deprecated.svg' alt='Deprecated lifecycle' /></p>
<p><code>with_mock()</code> and <code>local_mock()</code> are deprecated in the third edition.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Suraj Gupta (2012): <a href='http://obeautifulcode.com/R/How-R-Searches-And-Finds-Stuff'>How R Searches And Finds Stuff</a></p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='no'>add_one</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>x</span>) <span class='no'>x</span> + <span class='fl'>1</span>
<span class='fu'><a href='equality-expectations.html'>expect_equal</a></span>(<span class='fu'>add_one</span>(<span class='fl'>2</span>), <span class='fl'>3</span>)
<span class='fu'>with_mock</span>(
  <span class='kw'>add_one</span> <span class='kw'>=</span> <span class='kw'>function</span>(<span class='no'>x</span>) <span class='no'>x</span> - <span class='fl'>1</span>,
  <span class='fu'><a href='equality-expectations.html'>expect_equal</a></span>(<span class='fu'>add_one</span>(<span class='fl'>2</span>), <span class='fl'>1</span>)
)</div><div class='output co'>#&gt; <span class='error'>Error: Function add_one not found in environment testthat.</span></div><div class='input'><span class='no'>square_add_one</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>x</span>) <span class='fu'>add_one</span>(<span class='no'>x</span>)^<span class='fl'>2</span>
<span class='fu'><a href='equality-expectations.html'>expect_equal</a></span>(<span class='fu'>square_add_one</span>(<span class='fl'>2</span>), <span class='fl'>9</span>)
<span class='fu'><a href='equality-expectations.html'>expect_equal</a></span>(
  <span class='fu'>with_mock</span>(
    <span class='kw'>add_one</span> <span class='kw'>=</span> <span class='kw'>function</span>(<span class='no'>x</span>) <span class='no'>x</span> - <span class='fl'>1</span>,
    <span class='fu'>square_add_one</span>(<span class='fl'>2</span>)
  ),
  <span class='fl'>1</span>
)</div><div class='output co'>#&gt; <span class='error'>Error: Function add_one not found in environment testthat.</span></div><div class='input'>
<span class='co'># local_mock() -------------------------------</span>
<span class='no'>plus</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>x</span>, <span class='no'>y</span>) <span class='no'>x</span> + <span class='no'>y</span>
<span class='fu'><a href='test_that.html'>test_that</a></span>(<span class='st'>"plus(1, 1) == 2"</span>, {
  <span class='fu'><a href='equality-expectations.html'>expect_equal</a></span>(<span class='fu'>plus</span>(<span class='fl'>1</span>, <span class='fl'>1</span>), <span class='fl'>2</span>)
})</div><div class='output co'>#&gt; <span style='color: #00BB00;'>Test passed</span><span> ðŸŒˆ</div><div class='input'>
<span class='fu'><a href='test_that.html'>test_that</a></span>(<span class='st'>"plus(1, 1) == 3"</span>, {
  <span class='fu'>local_mock</span>(<span class='kw'>plus</span> <span class='kw'>=</span> <span class='kw'>function</span>(<span class='no'>x</span>, <span class='no'>y</span>) <span class='fl'>3</span>)
  <span class='fu'><a href='equality-expectations.html'>expect_equal</a></span>(<span class='fu'>plus</span>(<span class='fl'>1</span>, <span class='fl'>1</span>), <span class='fl'>3</span>)
})</div><div class='output co'>#&gt; â”€â”€ </span><span style='color: #BBBB00;font-weight: bold;'>Error</span><span style='font-weight: bold;'> (&lt;text&gt;:24:3): plus(1, 1) == 3</span><span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#&gt; Error: Function plus not found in environment testthat.
#&gt; </span><span style='font-weight: bold;'>Backtrace:</span><span>
#&gt; </span><span style='color: #555555;'> 1. </span><span>testthat::local_mock(plus = function(x, y) 3)
#&gt; </span><span style='color: #555555;'> 2. </span><span>testthat:::extract_mocks(list(...), .env = .env)
#&gt; </span><span style='color: #555555;'> 3. </span><span>base::lapply(...)
#&gt; </span><span style='color: #555555;'> 4. </span><span>testthat:::FUN(X[[i]], ...)
#&gt; </div></span></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by <a href='http://hadley.nz'>Hadley Wickham</a>, <a href='https://www.rstudio.com'><img src='https://www.tidyverse.org/rstudio-logo.svg' alt='RStudio' height='24' /></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


