<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test fixtures ‚Ä¢ testthat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Test fixtures">
<meta property="og:description" content="testthat">
<meta property="og:image" content="https://testthat.r-lib.org/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">testthat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/custom-expectation.html">Custom expectations</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Running tests in parallel</a>
    </li>
    <li>
      <a href="../articles/skipping.html">Skipping tests</a>
    </li>
    <li>
      <a href="../articles/snapshotting.html">Snapshot tests</a>
    </li>
    <li>
      <a href="../articles/test-fixtures.html">Test fixtures</a>
    </li>
    <li>
      <a href="../articles/third-edition.html">testthat 3e</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Releases</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2020/10/testthat-3-0-0/">Version 3.0.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/testthat/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="test-fixtures_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="test-fixtures_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="test-fixtures_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Test fixtures</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/master/vignettes/test-fixtures.Rmd"><code>vignettes/test-fixtures.Rmd</code></a></small>
      <div class="hidden name"><code>test-fixtures.Rmd</code></div>

    </div>

    
    
<div id="test-hygiene" class="section level2">
<h2 class="hasAnchor">
<a href="#test-hygiene" class="anchor"></a>Test hygiene</h2>
<blockquote>
<p>Take nothing but memories, leave nothing but footprints.</p>
<p>‚Äï Chief Si‚Äôahl</p>
</blockquote>
<p>Ideally, a test should leave the world exactly as it found it. But you often need to make some changes in order to exercise every part of your code:</p>
<ul>
<li>Create a file or directory</li>
<li>Create a resource on an external system</li>
<li>Set an R option</li>
<li>Set an environment variable</li>
<li>Change working directory</li>
<li>Change an aspect of the tested package‚Äôs state</li>
</ul>
<p>How can you clean up these changes to get back to a clean slate? Scrupulous attention to cleanup is more than just courtesy or being fastidious. It is also self-serving. The state of the world after test <code>i</code> is the starting state for test <code>i + 1</code>. Tests that change state willy-nilly eventually end up interfering with each other in ways that can be very difficult to debug.</p>
<p>Most tests are written with an implicit assumption about the starting state, usually whatever <em>tabula rasa</em> means for the target domain of your package. If you accumulate enough sloppy tests, you will eventually find yourself asking the programming equivalent of questions like ‚ÄúWho forgot to turn off the oven?‚Äù and ‚ÄúWho didn‚Äôt clean up after the dog?‚Äù.</p>
<p>It‚Äôs also important that your setup and cleanup is easy to use when working interactively. When a test fails, you want to be able to quickly recreate the exact environment in which the test is run so you can interactively experiment to figure out what went wrong.</p>
<p>This article introduces a powerful technique that allows you to solve both problems: <strong>test fixtures</strong>. We‚Äôll begin with an introduction to the tools that make fixtures possible, then talk about exactly what a test fixture is, and show a few examples.</p>
<p>Much of this vignette is derived from <a href="https://www.tidyverse.org/blog/2020/04/self-cleaning-test-fixtures/" class="uri">https://www.tidyverse.org/blog/2020/04/self-cleaning-test-fixtures/</a>; if this is your first encounter with <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> or <code><a href="https://withr.r-lib.org/reference/defer.html">withr::defer()</a></code>, I‚Äôd recommend starting with that blog as it gives a gentler introduction. This vignette moves a little faster since it‚Äôs designed as more of a reference doc.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="foundations" class="section level2">
<h2 class="hasAnchor">
<a href="#foundations" class="anchor"></a>Foundations</h2>
<p>Before we can talk about test fixtures, we need to lay some foundations to help you understand how they work. We‚Äôll motivate the discussion with a <code>sloppy()</code> function that prints a number with a specific number of significant digits by adjusting an R option:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sloppy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span>
<span class="fu">sloppy</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.1</span>
<span class="va">pi</span>
<span class="co">#&gt; [1] 3.1</span></code></pre></div>
<p>Notice how <code>pi</code> prints differently before and after the call to <code>sloppy()</code>. Calling <code>sloppy()</code> has a side effect: it changes the <code>digits</code> option globally, not just within its own scope of operations. This is what we want to avoid<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
<div id="on-exit" class="section level3">
<h3 class="hasAnchor">
<a href="#on-exit" class="anchor"></a><code>on.exit()</code>
</h3>
<p>The first function you need to know about is base R‚Äôs <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code>. <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> calls the code to supplied to its first argument when the current function exits, regardless of whether it returns a value or errors. You can use <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> to clean up after yourself by ensuring that every mess-making function call is paired with an <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> call that cleans up.</p>
<p>We can use this idea to turn <code>sloppy()</code> into <code>neat()</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, after <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span>
<span class="fu">neat</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.1</span>
<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span></code></pre></div>
<p>Here we make use of a useful pattern <code><a href="https://rdrr.io/r/base/options.html">options()</a></code> implements: when you call <code><a href="https://rdrr.io/r/base/options.html">options(digits = sig_digits)</a></code> it both sets the <code>digits</code> option <em>and</em> (invisibly) returns the previous value of digits. We can then use that value to restore the previous options.</p>
<p><code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> also works in tests:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"can print one digit of pi"</span>, <span class="op">{</span>
  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, after <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  
  <span class="fu"><a href="../reference/expect_output.html">expect_output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">pi</span><span class="op">)</span>, <span class="st">"3"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Test passed ü•á</span>
<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span></code></pre></div>
<p>There are three main drawbacks to <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code>:</p>
<ul>
<li><p>You should always call it with <code>add = TRUE</code> and <code>after = FALSE</code>. These ensure that the call is <strong>added</strong> to the list of deferred tasks (instead of replaces) and is added to the <strong>front</strong> of the stack (not the back, so that cleanup occurs in reverse order to setup). These arguments only matter if you‚Äôre using multiple <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> calls, but it‚Äôs a good habit to always use them to avoid potential problems down the road.</p></li>
<li>
<p>It doesn‚Äôt work outside a function or test. If you run the following code in the global environment, you won‚Äôt get an error, but the cleanup code will never be run:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, after <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>This is annoying when you are running tests interactively.</p>
</li>
<li><p>You can‚Äôt program with it; <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> always works inside the <em>current</em> function so you can‚Äôt wrap up repeated <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> code in a helper function.</p></li>
</ul>
<p>To resolve these drawbacks, we use <code><a href="https://withr.r-lib.org/reference/defer.html">withr::defer()</a></code>.</p>
</div>
<div id="withrdefer" class="section level3">
<h3 class="hasAnchor">
<a href="#withrdefer" class="anchor"></a><code>withr::defer()</code>
</h3>
<p><code><a href="https://withr.r-lib.org/reference/defer.html">withr::defer()</a></code> resolves the main drawbacks of <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code>. First, it has the behaviour we want by default; no extra arguments needed:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Second, it works when called in the global environment. Since the global environment isn‚Äôt perishable, like a test environment is, you have to call <code>deferred_run()</code> explicitly to execute the deferred events. You can also clear them, without running, with <code>deferred_clear()</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"hi"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Setting deferred event(s) on global environment.</span>
<span class="co">#&gt;   * Execute (and clear) with `withr::deferred_run()`.</span>
<span class="co">#&gt;   * Clear (without executing) with `withr::deferred_clear()`.</span>
<span class="co">#&gt; [1] "hi"</span>
<span class="co">#&gt; Setting deferred event(s) on global environment.</span>
<span class="co">#&gt;   * Execute (and clear) with `deferred_run()`.</span>
<span class="co">#&gt;   * Clear (without executing) with `deferred_clear()`.</span>

<span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">deferred_run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "hi"</span>
<span class="co">#&gt; [1] "hi"</span></code></pre></div>
<p>Finally, <code><a href="https://withr.r-lib.org/reference/defer.html">withr::defer()</a></code> lets you pick which function to bind the clean up behaviour too. This makes it possible to create helper functions.</p>
</div>
<div id="local-helpers" class="section level3">
<h3 class="hasAnchor">
<a href="#local-helpers" class="anchor"></a>‚ÄúLocal‚Äù helpers</h3>
<p>Imagine we have many functions where we want to temporarily set the digits option. Wouldn‚Äôt it be nice if we could write a helper function to automate? Unfortunately we can‚Äôt write a helper with <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">local_digits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, after <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">neater</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">local_digits</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">neater</span><span class="op">(</span><span class="va">pi</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.141593</span></code></pre></div>
<p>This code doesn‚Äôt work because the cleanup happens too soon, when <code>local_digits()</code> exists, not when <code>neat()</code> finishes.</p>
<p>Fortunately, <code><a href="https://withr.r-lib.org/reference/defer.html">withr::defer()</a></code> allows us to solve this problem by providing an <code>envir</code> argument that allows you to control when cleanup occurs. The exact details of how this works are rather complicated, but fortunately there‚Äôs a common pattern you can use without understanding all the details. Your helper function should always have an <code>env</code> argument that defaults to <code><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame()</a></code>, which you pass to the second argument of <code>defer()</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">local_digits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sig_digits</span>, <span class="va">env</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, <span class="va">env</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">neater</span><span class="op">(</span><span class="va">pi</span><span class="op">)</span>
<span class="co">#&gt; [1] 3</span></code></pre></div>
<p>Just like <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> and <code>defer()</code>, our helper also works within tests:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"withr lets us write custom helpers for local state manipulation"</span>, <span class="op">{</span>
  <span class="fu">local_digits</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="../reference/expect_output.html">expect_output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="st">"3"</span><span class="op">)</span>
  
  <span class="fu">local_digits</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
  <span class="fu"><a href="../reference/expect_output.html">expect_output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="st">"2.72"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Test passed üåà</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 2.718282</span></code></pre></div>
<p>We always call these helper functions <code>local_</code>; ‚Äúlocal‚Äù here refers to the fact that the state change persists only locally, for the lifetime of the associated function or test.</p>
</div>
<div id="pre-existing-helpers" class="section level3">
<h3 class="hasAnchor">
<a href="#pre-existing-helpers" class="anchor"></a>Pre-existing helpers</h3>
<p>But before you write your own helper function, make sure to check out the wide range of local functions already provided by withr:</p>
<table class="table">
<thead><tr class="header">
<th>Do / undo this</th>
<th>withr function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Create a file</td>
<td><code>local_file()</code></td>
</tr>
<tr class="even">
<td>Set an R option</td>
<td><code>local_options()</code></td>
</tr>
<tr class="odd">
<td>Set an environment variable</td>
<td><code>local_envvar()</code></td>
</tr>
<tr class="even">
<td>Change working directory</td>
<td><code>local_dir()</code></td>
</tr>
</tbody>
</table>
<p>We can use <code><a href="https://withr.r-lib.org/reference/with_options.html">withr::local_options()</a></code> to write yet another version of <code>neater()</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neatest</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html">local_options</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">neatest</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.14</span></code></pre></div>
<p>Each <code>local_*()</code> function has a companion <code>with_()</code> function, which is a nod to <code><a href="https://rdrr.io/r/base/with.html">with()</a></code>, and the inspiration for withr‚Äôs name. We won‚Äôt use the <code>with_*()</code> functions here, but you can learn more about them at <a href="https://withr.r-lib.org">withr.r-lib.org</a>.</p>
</div>
</div>
<div id="test-fixtures" class="section level2">
<h2 class="hasAnchor">
<a href="#test-fixtures" class="anchor"></a>Test fixtures</h2>
<p>Testing is often demonstrated with cute little tests and functions where all the inputs and expected results can be inlined. But in real packages, things aren‚Äôt always so simple and functions often depend on other global state. For example, take this variant on <code><a href="https://rdrr.io/r/base/message.html">message()</a></code> that only shows a message if the <code>verbose</code> option is <code>TRUE</code>. How would you test that setting the option does indeed silence the message?</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">message2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"verbose"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>In some cases, it‚Äôs possible to make the global state an explicit argument to the function. For example, we could refactor <code>message2()</code> to make the verbosity an explicit argument:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">message3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">verbose</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"verbose"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="va">verbose</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Making external state explicit is often worthwhile, because it makes it more clear exactly what inputs determine the outputs of your function. But it‚Äôs simply not possible in many cases. That‚Äôs where test fixtures come in: they allow you to temporarily change global state in order to test your function. Test fixture is a pre-existing term in the software engineering world (and beyond):</p>
<blockquote>
<p>A test fixture is something used to consistently test some item, device, or piece of software.</p>
<p>‚Äî <a href="https://en.wikipedia.org/wiki/Test_fixture">Wikipedia</a></p>
</blockquote>
<p>A <strong>test fixture</strong> is just a <code>local_</code> function that you use to change state in such a way that you can reach inside and test parts of your code that would otherwise be challenging. For example, here‚Äôs how you could use <code><a href="https://withr.r-lib.org/reference/with_options.html">withr::local_options()</a></code> as a test fixture to test <code>message2()</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"message2() output depends on verbose option"</span>, <span class="op">{</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html">local_options</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="../reference/expect_error.html">expect_message</a></span><span class="op">(</span><span class="fu">message2</span><span class="op">(</span><span class="st">"Hi!"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html">local_options</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="../reference/expect_error.html">expect_message</a></span><span class="op">(</span><span class="fu">message2</span><span class="op">(</span><span class="st">"Hi!"</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; now dyn.load("/Users/runner/work/_temp/Library/ellipsis/libs/ellipsis.so") ...</span>
<span class="co">#&gt; Test passed ü•á</span></code></pre></div>
<div id="case-study-usethis" class="section level3">
<h3 class="hasAnchor">
<a href="#case-study-usethis" class="anchor"></a>Case study: usethis</h3>
<p>One place that we use test fixtures extensively is in the usethis package (<a href="https://usethis.r-lib.org">usethis.r-lib.org</a>), which provides functions for looking after the files and folders in R projects, especially packages. Many of these functions only make sense in the context of a package, which means to test them, we also have to be working inside an R package. We need a way to quickly spin up a minimal package in a temporary directory, then test some functions against it, then destroy it.</p>
<p>To solve this problem we create a test fixture, which we place in <code>R/test-helpers.R</code> so that‚Äôs it‚Äôs available for both testing and interactive experimentation:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">local_create_package</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dir</span> <span class="op">=</span> <span class="fu">file_temp</span><span class="op">(</span><span class="op">)</span>, <span class="va">env</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">old_project</span> <span class="op">&lt;-</span> <span class="fu">proj_get_</span><span class="op">(</span><span class="op">)</span>
  
  <span class="co"># create new folder and package</span>
  <span class="fu">create_package</span><span class="op">(</span><span class="va">dir</span>, open <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># A</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">defer</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/delete.html">dir_delete</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span>, envir <span class="op">=</span> <span class="va">env</span><span class="op">)</span> <span class="co"># -A</span>
  
  <span class="co"># change working directory</span>
  <span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span> <span class="co"># B</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span><span class="op">(</span><span class="va">old_project</span><span class="op">)</span>, envir <span class="op">=</span> <span class="va">env</span><span class="op">)</span> <span class="co"># -B</span>
  
  <span class="co"># switch to new usethis project</span>
  <span class="fu">proj_set</span><span class="op">(</span><span class="va">dir</span><span class="op">)</span> <span class="co"># C</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">defer</a></span><span class="op">(</span><span class="fu">proj_set</span><span class="op">(</span><span class="va">old_project</span>, force <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, envir <span class="op">=</span> <span class="va">env</span><span class="op">)</span> <span class="co"># -C</span>
  
  <span class="va">dir</span>
<span class="op">}</span></code></pre></div>
<p>Note that the cleanup automatically unfolds in the opposite order from the setup. Setup is <code>A</code>, then <code>B</code>, then <code>C</code>; cleanup is <code>-C</code>, then <code>-B</code>, then <code>-A</code>. This is important because we must create directory <code>dir</code> before we can make it the working directory; and we must restore the original working directory before we can delete <code>dir</code>; we can‚Äôt delete <code>dir</code> while it‚Äôs still the working directory!</p>
<p><code>create_local_package()</code> is used in over 170 tests. Here‚Äôs one example that checks that <code><a href="https://usethis.r-lib.org/reference/use_roxygen_md.html">usethis::use_roxygen_md()</a></code> does the setup necessary to use roxygen2 in a package, with markdown support turned on. All 3 expectations consult the DESCRIPTION file, directly or indirectly. So it‚Äôs very convenient that <code>create_local_package()</code> creates a minimal package, with a valid <code>DESCRIPTION</code> file, for us to test against. And when the test is done ‚Äî poof! ‚Äî the package is gone.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">test_that</span>(<span class="st">"use_roxygen_md() adds DESCRIPTION fields"</span>, {</span>
<span id="cb16-2"><a href="#cb16-2"></a>  pkg &lt;-<span class="st"> </span><span class="kw">local_create_package</span>()</span>
<span id="cb16-3"><a href="#cb16-3"></a>  <span class="kw">use_roxygen_md</span>()</span>
<span id="cb16-4"><a href="#cb16-4"></a>  </span>
<span id="cb16-5"><a href="#cb16-5"></a>  <span class="kw">expect_true</span>(<span class="kw">uses_roxygen_md</span>())</span>
<span id="cb16-6"><a href="#cb16-6"></a>  <span class="kw">expect_equal</span>(desc<span class="op">::</span><span class="kw">desc_get</span>(<span class="st">"Roxygen"</span>, pkg)[[<span class="dv">1</span>]], <span class="st">"list(markdown = TRUE)"</span>)<span class="er">)</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>  <span class="kw">expect_true</span>(desc<span class="op">::</span><span class="kw">desc_has_fields</span>(<span class="st">"RoxygenNote"</span>, pkg))</span>
<span id="cb16-8"><a href="#cb16-8"></a>})</span></code></pre></div>
</div>
</div>
<div id="scope" class="section level2">
<h2 class="hasAnchor">
<a href="#scope" class="anchor"></a>Scope</h2>
<p>So far we have applied our test fixture to individual tests, but it‚Äôs also possible to apply them to a file or package.</p>
<div id="file" class="section level3">
<h3 class="hasAnchor">
<a href="#file" class="anchor"></a>File</h3>
<p>If you move the <code>local_()</code> call outside of a <code><a href="../reference/test_that.html">test_that()</a></code> block, it will affect all tests that come after it. This means that by calling the test fixture at the top of the file you can change the behaviour for all tests. This has both advantages and disadvantages:</p>
<ul>
<li><p>If you would otherwise have called the fixture in every test, you‚Äôve saved yourself a bunch of work and duplicate code.</p></li>
<li><p>But on the downside, if you a test fails and you want to recreate the failure in an interactive environment so you can debug, you need to remember to run all the setup code at the top of the file first.</p></li>
</ul>
<p>Generally, I think it‚Äôs better to copy and paste test fixtures across many tests ‚Äî sure, it adds some duplication to your code, but it makes debugging test failures so much easier.</p>
</div>
<div id="package" class="section level3">
<h3 class="hasAnchor">
<a href="#package" class="anchor"></a>Package</h3>
<p>To run code before any test is run, you can create a file called <code>test/testthat/setup.R</code>. If the code in this file needs clean up, you can use the special <code><a href="../reference/teardown_env.html">teardown_env()</a></code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Run before any test</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="st">"mtcars.csv"</span>, <span class="va">mtcars</span><span class="op">)</span>

<span class="co"># Run after all tests</span>
<span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"mtcars.csv"</span><span class="op">)</span>, <span class="fu"><a href="../reference/teardown_env.html">teardown_env</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Setup code is typically best used to create external resources that are needed by many tests. It‚Äôs best kept to a minimum because you will have to manually run it before interactively debugging tests.</p>
</div>
</div>
<div id="other-challenges" class="section level2">
<h2 class="hasAnchor">
<a href="#other-challenges" class="anchor"></a>Other challenges</h2>
<p>A collection of miscellaneous problems that I don‚Äôt know where else to describe:</p>
<ul>
<li><p>There are a few base functions that are hard to test because they depend on state that you can‚Äôt control. One such example is <code><a href="https://rdrr.io/r/base/interactive.html">interactive()</a></code>: there‚Äôs no way to write a test fixture that allows you to pretend that interactive is either <code>TRUE</code> or <code>FALSE</code>. So we now usually use <code><a href="https://rlang.r-lib.org/reference/is_interactive.html">rlang::is_interactive()</a></code> which can be controlled by the <code>rlang_interactive</code> option.</p></li>
<li><p>If you‚Äôre using a test fixture in a function, be careful about what you return. For example, if you write a function that does <code>dir &lt;- create_local_package()</code> you shouldn‚Äôt return <code>dir</code>, because after the function returns the directory will no longer exist.</p></li>
</ul>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Don‚Äôt worry, I‚Äôm restoring global state (specifically, the <code>digits</code> option) behind the scenes here.<a href="#fnref1" class="footnote-back">‚Ü©Ô∏é</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
