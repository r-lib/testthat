<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Mocking â€¢ testthat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="â€image/svg+xmlâ€" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mocking">
<meta name="robots" content="noindex">
<script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="testthat.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">testthat</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">3.2.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Setup</h6></li>
    <li><a class="dropdown-item" href="../articles/third-edition.html">testthat 3e</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Running tests in parallel</a></li>
    <li><a class="dropdown-item" href="../articles/special-files.html">Special files</a></li>
    <li><a class="dropdown-item" href="../articles/custom-expectation.html">Custom expectations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Techniques</h6></li>
    <li><a class="dropdown-item" href="../articles/challenging-tests.html">Testing challenging functions</a></li>
    <li><a class="dropdown-item" href="../articles/mocking.html">Mocking</a></li>
    <li><a class="dropdown-item" href="../articles/skipping.html">Skipping tests</a></li>
    <li><a class="dropdown-item" href="../articles/snapshotting.html">Snapshot tests</a></li>
    <li><a class="dropdown-item" href="../articles/test-fixtures.html">Test fixtures</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/10/testthat-3-2-0/">Version 3.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/10/testthat-3-1/">Version 3.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/10/testthat-3-0-0/">Version 3.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/testthat/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Mocking</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/main/vignettes/mocking.Rmd" class="external-link"><code>vignettes/mocking.Rmd</code></a></small>
      <div class="d-none name"><code>mocking.Rmd</code></div>
    </div>

    
    
<p>Mocking allows you to temporarily replace the implementation of a
function with something that makes it easier to test. Itâ€™s useful when
testing failure scenarios that are hard to generate organically (e.g.,
what happens if dependency X isnâ€™t installed?), making tests more
reliable, and making tests faster. Itâ€™s also a general escape hatch to
resolve almost any challenging testing problem. That said, mocking comes
with downsides too: itâ€™s an advanced technique that can lead to brittle
tests or tests that silently conceal problems. You should only use it
when all other approaches fail.</p>
<p>(If, like me, youâ€™re confused as to why youâ€™d want to cruelly make
fun of your tests, mocking here is used in the sense of making a fake or
simulated version of something, i.e., a mock-up.)</p>
<p>testthatâ€™s primary mocking tool is
<code><a href="../reference/local_mocked_bindings.html">local_mocked_bindings()</a></code> which is used to mock functions and
is the focus of this vignette. But it also provides other tools for
specialized cases: you can use <code><a href="../reference/local_mocked_s3_method.html">local_mocked_s3_method()</a></code> to
mock an S3 method, <code><a href="../reference/local_mocked_s3_method.html">local_mocked_s4_method()</a></code> to mock an S4
method, and <code><a href="../reference/local_mocked_r6_class.html">local_mocked_r6_class()</a></code> to mock an R6 class.
Once you understand the basic idea of mocking, it should be
straightforward to apply these other tools where needed.</p>
<p>In this vignette, weâ€™ll start by illustrating the basics of mocking
with a few examples, continue to some real-world case studies from
throughout the tidyverse, then finish up with the technical details so
you can understand the tradeoffs of the current implementation.</p>
<div class="section level2">
<h2 id="getting-started-with-mocking">Getting started with mocking<a class="anchor" aria-label="anchor" href="#getting-started-with-mocking"></a>
</h2>
<p>Letâ€™s begin by motivating mocking with a simple example. Imagine
youâ€™re writing a function like <code><a href="https://rlang.r-lib.org/reference/is_installed.html" class="external-link">rlang::check_installed()</a></code>.
The goal of this function is to check if a package is installed, and if
not, give a nice error message. It also takes an optional
<code>min_version</code> argument that you can use to enforce a version
constraint. A simple base R implementation might look something like
this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">check_installed</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span>, <span class="va">min_version</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="va">pkg</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"{%s} is not installed."</span>, <span class="va">pkg</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">min_version</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pkg_version</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="va">pkg</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">pkg_version</span> <span class="op">&lt;</span> <span class="va">min_version</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>        <span class="st">"{%s} version %s is installed, but %s is required."</span>, </span>
<span>        <span class="va">pkg</span>, </span>
<span>        <span class="va">pkg_version</span>, </span>
<span>        <span class="va">min_version</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now that weâ€™ve written this function, we want to test it. There are
many ways we might tackle this, but itâ€™s reasonable to start by testing
the case where we donâ€™t specify a minimum version. To do this, we need
to come up with a package we know is installed and a package we know
isnâ€™t installed:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"check_installed() checks package is installed"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_no_error.html">expect_no_error</a></span><span class="op">(</span><span class="fu">check_installed</span><span class="op">(</span><span class="st">"testthat"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu">check_installed</span><span class="op">(</span><span class="st">"doesntexist"</span><span class="op">)</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: check_installed() checks package is installed</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   check_installed("doesntexist")</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `check_installed()`:</span></span>
<span><span class="co">#&gt;   ! {doesntexist} is not installed.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes ğŸ¥‡</span>.</span></span></code></pre></div>
<p>This is probably fine as we certainly know that testthat must be
installed but it feels a little fragile as it depends on external state
that we donâ€™t control. While itâ€™s pretty unlikely, if someone does
create a <code>doesntexist</code> package, this test will no longer
work. As a general principle, the less your tests rely on state outside
of your control, the more robust and reliable theyâ€™ll be.</p>
<p>Next we want to check the case where we specify a minimum version,
and again we need to make up some inputs:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"check_installed() checks minimum version"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_no_error.html">expect_no_error</a></span><span class="op">(</span><span class="fu">check_installed</span><span class="op">(</span><span class="st">"testthat"</span>, <span class="st">"1.0.0"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu">check_installed</span><span class="op">(</span><span class="st">"testthat"</span>, <span class="st">"99.99.999"</span><span class="op">)</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: check_installed() checks minimum version</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   check_installed("testthat", "99.99.999")</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `check_installed()`:</span></span>
<span><span class="co">#&gt;   ! {testthat} version 3.2.3.9000 is installed, but 99.99.999 is required.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes ğŸŠ</span>.</span></span></code></pre></div>
<p>Again, this is probably safe (since Iâ€™m unlikely to release 90+ new
versions of testthat), but if you look at the snapshot message
carefully, youâ€™ll notice that it includes the current version of
testthat. That means every time a new version of testthat is released,
weâ€™ll have to update the snapshot. We could use the
<code>transform</code> argument to fix this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"check_installed() checks minimum version"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_no_error.html">expect_no_error</a></span><span class="op">(</span><span class="fu">check_installed</span><span class="op">(</span><span class="st">"testthat"</span>, <span class="st">"1.0.0"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span></span>
<span>    <span class="fu">check_installed</span><span class="op">(</span><span class="st">"testthat"</span>, <span class="st">"99.99.999"</span><span class="op">)</span>, </span>
<span>    error <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    transform <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">lines</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"testthat"</span><span class="op">)</span>, <span class="st">"&lt;version&gt;"</span>, <span class="va">lines</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: check_installed() checks minimum version</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   check_installed("testthat", "99.99.999")</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `check_installed()`:</span></span>
<span><span class="co">#&gt;   ! {testthat} version &lt;version&gt; is installed, but 99.99.999 is required.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes ğŸŒˆ</span>.</span></span></code></pre></div>
<p>But itâ€™s starting to feel like weâ€™ve accumulating more and more
hacks. So letâ€™s take a fresh look and see how mocking might help us. The
basic idea of mocking is to temporarily replace the implementation of
functions being used by the function weâ€™re testing. Here weâ€™re testing
<code>check_installed()</code> and want to mock
<code><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace()</a></code> and <code><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion()</a></code> so we
can control their versions. Thereâ€™s a small wrinkle here in that
<code>requireNamespace</code> and <code>packageVersion</code> are base
functions, not our functions, so we need to make bindings in our package
namespace so we can mock them (weâ€™ll come back to why later).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">requireNamespace</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">packageVersion</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>For the first test, we mock <code><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace()</a></code> twice:
first to always return <code>TRUE</code> (pretending every package is
installed), and then to always return <code>FALSE</code> (pretending
that no packages are installed). Now the test is completely
self-contained and doesnâ€™t depend on what packages happen to be
installed.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"check_installed() checks package is installed"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span>requireNamespace <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_no_error.html">expect_no_error</a></span><span class="op">(</span><span class="fu">check_installed</span><span class="op">(</span><span class="st">"package-name"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span>requireNamespace <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu">check_installed</span><span class="op">(</span><span class="st">"package-name"</span><span class="op">)</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: check_installed() checks package is installed</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   check_installed("package-name")</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `check_installed()`:</span></span>
<span><span class="co">#&gt;   ! {package-name} is not installed.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes ğŸŠ</span>.</span></span></code></pre></div>
<p>For the second test, we mock <code><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace()</a></code> to
return <code>TRUE</code>, and then <code><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion()</a></code> to
always return version 2.0.0. This again ensures our test is independent
of system state.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"check_installed() checks minimum version"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span></span>
<span>    requireNamespace <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="cn">TRUE</span>,</span>
<span>    packageVersion <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric_version.html" class="external-link">numeric_version</a></span><span class="op">(</span><span class="st">"2.0.0"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="../reference/expect_no_error.html">expect_no_error</a></span><span class="op">(</span><span class="fu">check_installed</span><span class="op">(</span><span class="st">"package-name"</span>, <span class="st">"1.0.0"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu">check_installed</span><span class="op">(</span><span class="st">"package-name"</span>, <span class="st">"3.4.5"</span><span class="op">)</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: check_installed() checks minimum version</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   check_installed("package-name", "3.4.5")</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `check_installed()`:</span></span>
<span><span class="co">#&gt;   ! {package-name} version 2.0.0 is installed, but 3.4.5 is required.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes ğŸ¥‡</span>.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="case-studies">Case studies<a class="anchor" aria-label="anchor" href="#case-studies"></a>
</h2>
<p>To give you more experience with mocking, this section looks at a few
places where we use mocking in the tidyverse:</p>
<ul>
<li>Testing <code><a href="../reference/skip.html">testthat::skip_on_os()</a></code> regardless of what
operating system is running the test.</li>
<li>Speeding up <code><a href="https://usethis.r-lib.org/reference/use_release_issue.html" class="external-link">usethis::use_release_issue()</a></code>.</li>
<li>Testing the passage of time in
<code><a href="https://httr2.r-lib.org/reference/req_throttle.html" class="external-link">httr2::req_throttle()</a></code>.</li>
</ul>
<p>These situations are all a little complex, as this is the nature of
mocking: if you can use a simpler technique, you should. Mocking is only
needed for otherwise intractable problems.</p>
<div class="section level3">
<h3 id="pretending-were-on-a-different-platform">Pretending weâ€™re on a different platform<a class="anchor" aria-label="anchor" href="#pretending-were-on-a-different-platform"></a>
</h3>
<p><code><a href="../reference/skip.html">testthat::skip_on_os()</a></code> allows you to skip tests on
specific operating systems, using the internal <code>system_os()</code>
function which is a thin wrapper around
<code>Sys.info()[["sysname"]]</code>. To test that this skip works
correctly, we have to use mocking because thereâ€™s no other way to
pretend weâ€™re running on a different operating system. This yields the
following test, where we using mocking to pretend that weâ€™re always on
Windows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"can skip on multiple oses"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span>system_os <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="st">"windows"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_skip</span><span class="op">(</span><span class="fu"><a href="../reference/skip.html">skip_on_os</a></span><span class="op">(</span><span class="st">"windows"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">expect_skip</span><span class="op">(</span><span class="fu"><a href="../reference/skip.html">skip_on_os</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"windows"</span>, <span class="st">"linux"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">expect_no_skip</span><span class="op">(</span><span class="fu"><a href="../reference/skip.html">skip_on_os</a></span><span class="op">(</span><span class="st">"linux"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>(The logic of <code><a href="../reference/skip.html">skip_on_os()</a></code> is simple enough that I feel
confident we only need to simulate one platform.)</p>
</div>
<div class="section level3">
<h3 id="speeding-up-tests">Speeding up tests<a class="anchor" aria-label="anchor" href="#speeding-up-tests"></a>
</h3>
<p><code><a href="https://usethis.r-lib.org/reference/use_release_issue.html" class="external-link">usethis::use_release_issue()</a></code> creates a GitHub issue with
a bulleted list of actions to follow when releasing a package. But some
of the bullets depend on complex conditions that can take a while to
compute. So the <a href="https://github.com/r-lib/usethis/blob/main/tests/testthat/test-release.R" class="external-link">tests
for this function</a> use mocks like this:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span></span>
<span>  get_revdeps <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  gh_milestone_number <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here we pretend that there are no reverse dependencies (revdeps) for
the package, which is both slow to compute and will vary over time if we
use a real package. We also pretend that there are no related GitHub
milestones, which otherwise requires an GitHub API call, which is again
slow and might vary over time. Together, these mocks keep the tests fast
and self-contained, free from any state outside of our direct
control.</p>
</div>
<div class="section level3">
<h3 id="managing-time">Managing time<a class="anchor" aria-label="anchor" href="#managing-time"></a>
</h3>
<p><code><a href="https://httr2.r-lib.org/reference/req_throttle.html" class="external-link">httr2::req_throttle()</a></code> prevents multiple requests from
being made too quickly, using a technique called a leaky token bucket.
This technique is inextricably tied to real time because you want to
allow more requests as time elapses. So how do you test this? I started
by using <code><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep()</a></code>, but this made my tests both slow
(because Iâ€™d sleep for a second or two) and unreliable (because
sometimes more time elapsed than I expected). Eventually I figured out
that I could â€œmanually controlâ€ time by using a <a href="https://github.com/r-lib/httr2/blob/main/tests/testthat/test-req-throttle.R" class="external-link">mocked
function</a> that returns the value of a variable I control. This allows
me to manually advance time and carefully test the implications.</p>
<p>You can see the basic idea with a simpler example. Letâ€™s first begin
with a function that returns the â€œunix timeâ€, the number of seconds
elapsed since midnight on Jan 1, 1970. This is easy to compute, but will
make some computations simpler later as well as providing a convenient
function to mock.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unix_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">unix_time</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1762544944</span></span></code></pre></div>
<p>Now Iâ€™m going to create a function factory that makes it easy to
compute how much time has elapsed since some fixed starting point:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">elapsed</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">start</span> <span class="op">&lt;-</span> <span class="fu">unix_time</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">unix_time</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">timer</span> <span class="op">&lt;-</span> <span class="fu">elapsed</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu">timer</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.5045474</span></span></code></pre></div>
<p>Imagine trying to test this function without mocking! Youâ€™d probably
think itâ€™s not worth it. In fact, thatâ€™s what I thought originally, but
I soon learned my lesson because I introduce bug because Iâ€™d forgotten
the complexities of computing the difference between two POSIXct
values.</p>
<p>With mocking, however, I can â€œmanipulate timeâ€ by mocking
<code>unix_time()</code> so that it returns the value of a variable I
control. Now I can write a reliable test:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"elapsed() measures elapsed time"</span>, <span class="op">{</span></span>
<span>  <span class="va">time</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span>unix_time <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">time</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">timer</span> <span class="op">&lt;-</span> <span class="fu">elapsed</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">timer</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">time</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">timer</span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes ğŸ‰</span>.</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="how-does-mocking-work">How does mocking work?<a class="anchor" aria-label="anchor" href="#how-does-mocking-work"></a>
</h2>
<p>To finish up, itâ€™s worth discussing how mocking works. The
fundamental challenge of mocking is that you want it to be â€œhygienicâ€,
i.e.Â it should only affect the operation of your package code, not all
running code. You can see why this might be problematic if you imagine
mocking a function that testthat itself uses: you donâ€™t want to
accidentally break testthat while trying to test your code! To achieve
this goal, <code><a href="../reference/local_mocked_bindings.html">local_mocked_bindings()</a></code> works by modifying your
packageâ€™s <a href="https://adv-r.hadley.nz/environments.html#special-environments" class="external-link">namespace
environment</a>.</p>
<p>You can implement the basic idea using base R code like this:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">old</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/getFromNamespace.html" class="external-link">getFromNamespace</a></span><span class="op">(</span><span class="st">"my_function"</span>, <span class="st">"mypackage"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/getFromNamespace.html" class="external-link">assignInNamespace</a></span><span class="op">(</span><span class="st">"my_function"</span>, <span class="va">new</span>, <span class="st">"mypackage"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run the test...</span></span>
<span></span>
<span><span class="co"># restore the previous value</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/getFromNamespace.html" class="external-link">assignInNamespace</a></span><span class="op">(</span><span class="st">"my_function"</span>, <span class="va">old</span>, <span class="st">"mypackage"</span><span class="op">)</span></span></code></pre></div>
<p>This implementation leads to two limitations of
<code><a href="../reference/local_mocked_bindings.html">local_mocked_bindings()</a></code>:</p>
<ol style="list-style-type: decimal">
<li><p>The package namespace is locked, which means that you canâ€™t add
new bindings to it. That means if you want to mock base functions, you
have to provide some binding that can be overridden. The easiest way to
do this is with something like <code>mean &lt;- NULL</code>. This
creates a binding that <code><a href="../reference/local_mocked_bindings.html">local_mocked_bindings()</a></code> can modify,
but because of Râ€™s <a href="https://adv-r.hadley.nz/functions.html#functions-versus-variables" class="external-link">lexical
scoping rules</a> doesnâ€™t affect ordinary calls.</p></li>
<li><p><code>::</code> doesnâ€™t use the package namespace, so if you want
to mock an explicitly namespaced function, you either have import
<code>fun</code> into your <code>NAMESPACE</code> (e.g., with
<code>@importFrom pkg fun</code>) or create your own wrapper function
that you can mock. Typically, one of these options will feel fairly
natural.</p></li>
</ol>
<p>Overall, these limitations feel correct to me:
<code><a href="../reference/local_mocked_bindings.html">local_mocked_bindings()</a></code> makes it easy to temporarily change
the implementation of functions that you have written, while offering
workarounds to override the implementations of functions that others
have written in the scope of your package.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer>
</body>
</html>
