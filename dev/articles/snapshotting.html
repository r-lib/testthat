<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Snapshot tests â€¢ testthat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="â€image/svg+xmlâ€" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Snapshot tests">
<meta name="robots" content="noindex">
<script defer data-domain="testthat.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">testthat</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">3.2.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/custom-expectation.html">Custom expectations</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Running tests in parallel</a></li>
    <li><a class="dropdown-item" href="../articles/skipping.html">Skipping tests</a></li>
    <li><a class="dropdown-item" href="../articles/snapshotting.html">Snapshot tests</a></li>
    <li><a class="dropdown-item" href="../articles/special-files.html">Special files</a></li>
    <li><a class="dropdown-item" href="../articles/test-fixtures.html">Test fixtures</a></li>
    <li><a class="dropdown-item" href="../articles/third-edition.html">testthat 3e</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/10/testthat-3-2-0/">Version 3.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/10/testthat-3-1/">Version 3.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/10/testthat-3-0-0/">Version 3.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/testthat/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Snapshot tests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/main/vignettes/snapshotting.Rmd" class="external-link"><code>vignettes/snapshotting.Rmd</code></a></small>
      <div class="d-none name"><code>snapshotting.Rmd</code></div>
    </div>

    
    
<p>The goal of a unit test is to record the expected output of a
function using code. This is a powerful technique because not only does
it ensure that code doesnâ€™t change unexpectedly, it also expresses the
desired behaviour in a way that a human can understand.</p>
<p>However, itâ€™s not always convenient to record the expected behaviour
with code. Some challenges include:</p>
<ul>
<li><p>Text output that includes many characters like quotes and
newlines that require special handling in a string.</p></li>
<li><p>Output that is large, making it painful to define the reference
output, and bloating the size of the test file and making it hard to
navigate.</p></li>
<li><p>Binary formats like plots or images, which are very difficult to
describe in code: i.e.Â the plot looks right, the error message is useful
to a human, the print method uses colour effectively.</p></li>
</ul>
<p>For these situations, testthat provides an alternative mechanism:
snapshot tests. Instead of using code to describe expected output,
snapshot tests (also known as <a href="https://ro-che.info/articles/2017-12-04-golden-tests" class="external-link">golden
tests</a>) record results in a separate human readable file. Snapshot
tests in testthat are inspired primarily by <a href="https://jestjs.io/docs/en/snapshot-testing" class="external-link">Jest</a>, thanks to a
number of very useful discussions with Joe Cheng.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="basic-workflow">Basic workflow<a class="anchor" aria-label="anchor" href="#basic-workflow"></a>
</h2>
<p>Weâ€™ll illustrate the basic workflow with a simple function that
generates an HTML heading. It can optionally include an <code>id</code>
attribute, which allows you to construct a link directly to that
heading.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bullets</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span>, <span class="va">id</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"&lt;ul"</span>, <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">" id=\""</span>, <span class="va">id</span>, <span class="st">"\""</span><span class="op">)</span>, <span class="st">"&gt;\n"</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"  &lt;li&gt;"</span>, <span class="va">text</span>, <span class="st">"&lt;/li&gt;\n"</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>    <span class="st">"&lt;/ul&gt;\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, id <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;ul id="x"&gt;</span></span>
<span><span class="co">#&gt;   &lt;li&gt;a&lt;/li&gt;</span></span>
<span><span class="co">#&gt; &lt;/ul&gt;</span></span></code></pre></div>
<p>Testing this simple function is relatively painful. To write the test
you have to carefully escape the newlines and quotes. And then when you
re-read the test in the future, all that escaping makes it hard to tell
exactly what itâ€™s supposed to return.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span>, <span class="st">"&lt;ul&gt;\n  &lt;li&gt;a&lt;/li&gt;\n&lt;/ul&gt;\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, id <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>, <span class="st">"&lt;ul id=\"x\"&gt;\n  &lt;li&gt;a&lt;/li&gt;\n&lt;/ul&gt;\n"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸ¥‡</span></span></code></pre></div>
<p>This is a great place to use snapshot testing. To do this we make two
changes to our code:</p>
<ul>
<li><p>We use <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> instead of
<code><a href="../reference/equality-expectations.html">expect_equal()</a></code></p></li>
<li><p>We wrap the call in <code><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat()</a></code> (to avoid <code>[1]</code>
in the output, like in my first interactive example).</p></li>
</ul>
<p>This yields the following test:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: bullets</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   cat(bullets("a"))</span></span>
<span><span class="co">#&gt; Output</span></span>
<span><span class="co">#&gt;   &lt;ul&gt;</span></span>
<span><span class="co">#&gt;     &lt;li&gt;a&lt;/li&gt;</span></span>
<span><span class="co">#&gt;   &lt;/ul&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: bullets</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   cat(bullets("a", "b"))</span></span>
<span><span class="co">#&gt; Output</span></span>
<span><span class="co">#&gt;   &lt;ul id="b"&gt;</span></span>
<span><span class="co">#&gt;     &lt;li&gt;a&lt;/li&gt;</span></span>
<span><span class="co">#&gt;   &lt;/ul&gt;</span></span></code></pre></div>
<p>When we run the test for the first time, it automatically generates
reference output, and prints it, so that you can visually confirm that
itâ€™s correct. The output is automatically saved in
<code>_snaps/{name}.md</code>. The name of the snapshot matches your
test file name â€” e.g.Â if your test is <code>test-pizza.R</code> then
your snapshot will be saved in
<code>test/testthat/_snaps/pizza.md</code>. As the file name suggests,
this is a markdown file, which Iâ€™ll explain shortly.</p>
<p>If you run the test again, itâ€™ll succeed:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸŠ</span></span></code></pre></div>
<p>But if you change the underlying code, say to tweak the indenting,
the test will fail:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bullets</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span>, <span class="va">id</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"&lt;ul"</span>, <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">" id=\""</span>, <span class="va">id</span>, <span class="st">"\""</span><span class="op">)</span>, <span class="st">"&gt;\n"</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"&lt;li&gt;"</span>, <span class="va">text</span>, <span class="st">"&lt;/li&gt;\n"</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>    <span class="st">"&lt;/ul&gt;\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BBBB00; font-weight: bold;">Failure</span><span style="font-weight: bold;">: bullets</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Snapshot of code has changed:</span></span>
<span><span class="co">#&gt;     old                 | new                    </span></span>
<span><span class="co">#&gt; [2] <span style="color: #555555;">  cat(bullets("a"))</span> | <span style="color: #555555;">  cat(bullets("a"))</span> [2]</span></span>
<span><span class="co">#&gt; [3] <span style="color: #555555;">Output</span>              | <span style="color: #555555;">Output</span>              [3]</span></span>
<span><span class="co">#&gt; [4] <span style="color: #555555;">  &lt;ul&gt;</span>              | <span style="color: #555555;">  &lt;ul&gt;</span>              [4]</span></span>
<span><span class="co">#&gt; [5] <span style="color: #00BB00;">    &lt;li&gt;a&lt;/li&gt;</span>      - <span style="color: #00BB00;">  &lt;li&gt;a&lt;/li&gt;</span>        [5]</span></span>
<span><span class="co">#&gt; [6] <span style="color: #555555;">  &lt;/ul&gt;</span>             | <span style="color: #555555;">  &lt;/ul&gt;</span>             [6]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; * Run `testthat::snapshot_accept('snapshotting.Rmd')` to accept the change.</span></span>
<span><span class="co">#&gt; * Run `testthat::snapshot_review('snapshotting.Rmd')` to review the change.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BBBB00; font-weight: bold;">Failure</span><span style="font-weight: bold;">: bullets</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Snapshot of code has changed:</span></span>
<span><span class="co">#&gt;     old                      | new                         </span></span>
<span><span class="co">#&gt; [2] <span style="color: #555555;">  cat(bullets("a", "b"))</span> | <span style="color: #555555;">  cat(bullets("a", "b"))</span> [2]</span></span>
<span><span class="co">#&gt; [3] <span style="color: #555555;">Output</span>                   | <span style="color: #555555;">Output</span>                   [3]</span></span>
<span><span class="co">#&gt; [4] <span style="color: #555555;">  &lt;ul id="b"&gt;</span>            | <span style="color: #555555;">  &lt;ul id="b"&gt;</span>            [4]</span></span>
<span><span class="co">#&gt; [5] <span style="color: #00BB00;">    &lt;li&gt;a&lt;/li&gt;</span>           - <span style="color: #00BB00;">  &lt;li&gt;a&lt;/li&gt;</span>             [5]</span></span>
<span><span class="co">#&gt; [6] <span style="color: #555555;">  &lt;/ul&gt;</span>                  | <span style="color: #555555;">  &lt;/ul&gt;</span>                  [6]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; * Run `testthat::snapshot_accept('snapshotting.Rmd')` to accept the change.</span></span>
<span><span class="co">#&gt; * Run `testthat::snapshot_review('snapshotting.Rmd')` to review the change.</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Test failed.</span></span></code></pre></div>
<p>If this is a deliberate change, you can follow the advice in the
message and update the snapshots for that file by running
<code>snapshot_accept("pizza")</code>; otherwise you can fix the bug and
your tests will pass once more. (You can also accept snapshot for all
files with <code><a href="../reference/snapshot_accept.html">snapshot_accept()</a></code>).</p>
<div class="section level3">
<h3 id="snapshot-format">Snapshot format<a class="anchor" aria-label="anchor" href="#snapshot-format"></a>
</h3>
<p>Snapshots are recorded using a subset of markdown. You might wonder
why we use markdown? Itâ€™s important that snapshots be readable by
humans, because humans have to look at it during code reviews. Reviewers
often donâ€™t run your code but still want to understand the changes.</p>
<p>Hereâ€™s the snapshot file generated by the test above:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode md"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu"># bullets</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="in">    &lt;ul&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="in">      &lt;li&gt;a&lt;/li&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="in">    &lt;/ul&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  </span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>---</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="in">    &lt;ul id="x"&gt;</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="in">      &lt;li&gt;a&lt;/li&gt;</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="in">    &lt;/ul&gt;</span></span></code></pre></div>
<p>Each test starts with <code># {test name}</code>, a level 1 heading.
Within a test, each snapshot expectation is indented by four spaces,
i.e.Â as code, and are separated by <code>---</code>, a horizontal
rule.</p>
</div>
<div class="section level3">
<h3 id="interactive-usage">Interactive usage<a class="anchor" aria-label="anchor" href="#interactive-usage"></a>
</h3>
<p>Because the snapshot output uses the name of the current test file
and the current test, snapshot expectations donâ€™t really work when run
interactively at the console. Since they canâ€™t automatically find the
reference output, they instead just print the current value for manual
inspection.</p>
</div>
</div>
<div class="section level2">
<h2 id="other-types-of-output">Other types of output<a class="anchor" aria-label="anchor" href="#other-types-of-output"></a>
</h2>
<p>So far weâ€™ve focussed on snapshot tests for output printed to the
console. But <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> also captures messages,
errors, and warnings<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;We no longer recommend
&lt;code&gt;&lt;a href="../reference/expect_snapshot_output.html"&gt;expect_snapshot_output()&lt;/a&gt;&lt;/code&gt;,
&lt;code&gt;&lt;a href="../reference/expect_snapshot_output.html"&gt;expect_snapshot_warning()&lt;/a&gt;&lt;/code&gt;, or
&lt;code&gt;&lt;a href="../reference/expect_snapshot_output.html"&gt;expect_snapshot_error()&lt;/a&gt;&lt;/code&gt;. Just use
&lt;code&gt;&lt;a href="../reference/expect_snapshot.html"&gt;expect_snapshot()&lt;/a&gt;&lt;/code&gt;.&lt;/p&gt;'><sup>1</sup></a>. The following function generates a some
output, a message, and a warning:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Hello"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Hi!"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"How are you?"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> captures them all:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"f() makes lots of noise"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: f() makes lots of noise</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   f()</span></span>
<span><span class="co">#&gt; Output</span></span>
<span><span class="co">#&gt;   [1] "Hello"</span></span>
<span><span class="co">#&gt; Message</span></span>
<span><span class="co">#&gt;   Hi!</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Warning in `f()`:</span></span>
<span><span class="co">#&gt;   How are you?</span></span></code></pre></div>
<p>Capturing errors is <em>slightly</em> more difficult because
<code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> will fail when thereâ€™s an error:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"you can't add a number and a letter"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="st">"a"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">: you can't add a number and a letter</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Error in `1 + "a"`: non-numeric argument to binary operator</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Backtrace:</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">    </span>â–†</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 1. </span>â””â”€<span style="font-weight: bold;">testthat</span>::expect_snapshot(1 + "a")</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 2. </span>  â””â”€<span style="font-weight: bold;">rlang</span>::cnd_signal(state$error)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Test failed.</span></span></code></pre></div>
<p>This is a safety valve that ensures that you donâ€™t accidentally write
broken code. To deliberately snapshot an error, youâ€™ll have to
specifically request it with <code>error = TRUE</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"you can't add a number and a letter"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="st">"a"</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: you can't add a number and a letter</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   1 + "a"</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `1 + "a"`:</span></span>
<span><span class="co">#&gt;   ! non-numeric argument to binary operator</span></span></code></pre></div>
<p>When the code gets longer, I like to put <code>error = TRUE</code> up
front so itâ€™s a little more obvious:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"you can't add weird things"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span>error <span class="op">=</span> <span class="cn">TRUE</span>, <span class="op">{</span></span>
<span>    <span class="fl">1</span> <span class="op">+</span> <span class="st">"a"</span></span>
<span>    <span class="va">mtcars</span> <span class="op">+</span> <span class="va">iris</span></span>
<span>    <span class="va">mean</span> <span class="op">+</span> <span class="va">sum</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: you can't add weird things</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   1 + "a"</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `1 + "a"`:</span></span>
<span><span class="co">#&gt;   ! non-numeric argument to binary operator</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   mtcars + iris</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `Ops.data.frame()`:</span></span>
<span><span class="co">#&gt;   ! '+' only defined for equally-sized data frames</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   mean + sum</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `mean + sum`:</span></span>
<span><span class="co">#&gt;   ! non-numeric argument to binary operator</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="snapshotting-values">Snapshotting values<a class="anchor" aria-label="anchor" href="#snapshotting-values"></a>
</h2>
<p><code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> is the most used snapshot function
because it records everything: the code you run, printed output,
messages, warnings, and errors. If you care about the return value
rather than any side-effects, you may might to use
<code><a href="../reference/expect_snapshot_value.html">expect_snapshot_value()</a></code> instead. It offers a number of
serialisation approaches that provide a tradeoff between accuracy and
human readability.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"can snapshot a simple list"</span>, <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"elephant"</span>, <span class="st">"banana"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot_value.html">expect_snapshot_value</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: can snapshot a simple list</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "a": [</span></span>
<span><span class="co">#&gt;     1,</span></span>
<span><span class="co">#&gt;     5,</span></span>
<span><span class="co">#&gt;     10</span></span>
<span><span class="co">#&gt;   ],</span></span>
<span><span class="co">#&gt;   "b": [</span></span>
<span><span class="co">#&gt;     "elephant",</span></span>
<span><span class="co">#&gt;     "banana"</span></span>
<span><span class="co">#&gt;   ]</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="whole-file-snapshotting">Whole file snapshotting<a class="anchor" aria-label="anchor" href="#whole-file-snapshotting"></a>
</h2>
<p><code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code>,
<code><a href="../reference/expect_snapshot_output.html">expect_snapshot_output()</a></code>,
<code><a href="../reference/expect_snapshot_output.html">expect_snapshot_error()</a></code>, and
<code><a href="../reference/expect_snapshot_value.html">expect_snapshot_value()</a></code> use one snapshot file per test
file. But that doesnâ€™t work for all file types â€” for example, what
happens if you want to snapshot an image?
<code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file()</a></code> provides an alternative workflow
that generates one snapshot per expectation, rather than one file per
test. Assuming youâ€™re in <code>test-burger.R</code> then the snapshot
created by
<code>expect_snapshot_file(code_that_returns_path_to_file(), "toppings.png")</code>
would be saved in
<code>tests/testthat/_snaps/burger/toppings.png</code>. If a future
change in the code creates a different file it will be saved in
<code>tests/testthat/_snaps/burger/toppings.new.png</code>.</p>
<p>Unlike <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> and friends,
<code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file()</a></code> canâ€™t provide an automatic diff when
the test fails. Instead youâ€™ll need to call
<code><a href="../reference/snapshot_accept.html">snapshot_review()</a></code>. This launches a Shiny app that allows
you to visually review each change and approve it if itâ€™s
deliberate:</p>
<p><img src="review-image.png" alt="Screenshot of the Shiny app for reviewing snapshot changes to images. It shows the changes to a png file of a plot created in a snapshot test. There is a button to accept the changed snapshot, or to skip it."></p>
<p><img src="review-text.png" alt="Screenshot of the Shiny app for reviewing snapshot changes to text files. It shows the changes to a .R file created in a snapshot test, where a line has been removed. There is a button to accept the changed snapshot, or to skip it."></p>
<p>The display varies based on the file type (currently text files,
common image files, and csv files are supported).</p>
<p>Sometimes the failure occurs in a non-interactive environment where
you canâ€™t run <code><a href="../reference/snapshot_accept.html">snapshot_review()</a></code>, e.g.Â in
<code>R CMD check</code>. In this case, the easiest fix is to retrieve
the <code>.new</code> file, copy it into the appropriate directory, then
run <code><a href="../reference/snapshot_accept.html">snapshot_review()</a></code> locally. If your code was run on a CI
platform, youâ€™ll need to start by downloading the run â€œartifactâ€, which
contains the check folder.</p>
<p>In most cases, we donâ€™t expect you to use
<code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file()</a></code> directly. Instead, youâ€™ll use it via
a wrapper that does its best to gracefully skip tests when differences
in platform or package versions make it unlikely to generate perfectly
reproducible output.</p>
</div>
<div class="section level2">
<h2 id="previous-work">Previous work<a class="anchor" aria-label="anchor" href="#previous-work"></a>
</h2>
<p>This is not the first time that testthat has attempted to provide
snapshot testing (although itâ€™s the first time I knew what other
languages called them). This section describes some of the previous
attempts and why we believe the new approach is better.</p>
<ul>
<li>
<p><code><a href="../reference/verify_output.html">verify_output()</a></code> has three main drawbacks:</p>
<ul>
<li><p>You have to supply a path where the output will be saved. This
seems like a small issue, but thinking of a good name, and managing the
difference between interactive and test-time paths introduces a
surprising amount of friction.</p></li>
<li><p>It always overwrites the previous result; automatically assuming
that the changes are correct. That means you have to use it with git and
itâ€™s easy to accidentally accept unwanted changes.</p></li>
<li><p>Itâ€™s relatively coarse grained, which means tests that use it
tend to keep growing and growing.</p></li>
</ul>
</li>
<li><p><code><a href="../reference/expect_known_output.html">expect_known_output()</a></code> is finer grained version of
<code><a href="../reference/verify_output.html">verify_output()</a></code> that captures output from a single
function. The requirement to produce a path for each individual
expectation makes it even more painful to use.</p></li>
<li><p><code><a href="../reference/expect_known_output.html">expect_known_value()</a></code> and
<code><a href="../reference/expect_known_output.html">expect_known_hash()</a></code> have all the disadvantages of
<code><a href="../reference/expect_known_output.html">expect_known_output()</a></code>, but also produce binary output
meaning that you canâ€™t easily review test differences in pull
requests.</p></li>
</ul>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
