<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Snapshot tests • testthat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Snapshot tests">
<meta name="robots" content="noindex">
<script defer data-domain="testthat.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">testthat</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">3.2.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Setup</h6></li>
    <li><a class="dropdown-item" href="../articles/third-edition.html">testthat 3e</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Running tests in parallel</a></li>
    <li><a class="dropdown-item" href="../articles/special-files.html">Special files</a></li>
    <li><a class="dropdown-item" href="../articles/custom-expectation.html">Custom expectations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Techniques</h6></li>
    <li><a class="dropdown-item" href="../articles/challenging-tests.html">Testing challenging functions</a></li>
    <li><a class="dropdown-item" href="../articles/mocking.html">Mocking</a></li>
    <li><a class="dropdown-item" href="../articles/skipping.html">Skipping tests</a></li>
    <li><a class="dropdown-item" href="../articles/snapshotting.html">Snapshot tests</a></li>
    <li><a class="dropdown-item" href="../articles/test-fixtures.html">Test fixtures</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/10/testthat-3-2-0/">Version 3.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/10/testthat-3-1/">Version 3.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/10/testthat-3-0-0/">Version 3.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/testthat/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Snapshot tests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/main/vignettes/snapshotting.Rmd" class="external-link"><code>vignettes/snapshotting.Rmd</code></a></small>
      <div class="d-none name"><code>snapshotting.Rmd</code></div>
    </div>

    
    
<p>The goal of a unit test is to record the expected output of a
function using code. This is a powerful technique because it not only
ensures that code doesn’t change unexpectedly, but it also expresses the
desired behavior in a way that a human can understand.</p>
<p>However, it’s not always convenient to record the expected behavior
with code. Some challenges include:</p>
<ul>
<li><p>Text output that includes many characters like quotes and
newlines that require special handling in a string.</p></li>
<li><p>Output that is large, making it painful to define the reference
output and bloating the size of the test file.</p></li>
<li><p>Binary formats like plots or images, which are very difficult to
describe in code: e.g., the plot looks right, the error message is
actionable, or the print method uses color effectively.</p></li>
</ul>
<p>For these situations, testthat provides an alternative mechanism:
snapshot tests. Instead of using code to describe expected output,
snapshot tests (also known as <a href="https://ro-che.info/articles/2017-12-04-golden-tests" class="external-link">golden
tests</a>) record results in a separate human-readable file. Snapshot
tests in testthat are inspired primarily by <a href="https://jestjs.io/docs/en/snapshot-testing" class="external-link">Jest</a>, thanks to a
number of very useful discussions with Joe Cheng.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="basic-workflow">Basic workflow<a class="anchor" aria-label="anchor" href="#basic-workflow"></a>
</h2>
<p>We’ll illustrate the basic workflow with a simple function that
generates HTML bullets. It can optionally include an <code>id</code>
attribute, which allows you to construct a link directly to that
list.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bullets</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span>, <span class="va">id</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"&lt;ul"</span>, <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">" id=\""</span>, <span class="va">id</span>, <span class="st">"\""</span><span class="op">)</span>, <span class="st">"&gt;\n"</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"  &lt;li&gt;"</span>, <span class="va">text</span>, <span class="st">"&lt;/li&gt;\n"</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>    <span class="st">"&lt;/ul&gt;\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, id <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;ul id="x"&gt;</span></span>
<span><span class="co">#&gt;   &lt;li&gt;a&lt;/li&gt;</span></span>
<span><span class="co">#&gt; &lt;/ul&gt;</span></span></code></pre></div>
<p>Testing this simple function is relatively painful. To write the test
you have to carefully escape the newlines and quotes. And then when you
re-read the test in the future, all that escaping makes it hard to tell
exactly what it’s supposed to return.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span>, <span class="st">"&lt;ul&gt;\n  &lt;li&gt;a&lt;/li&gt;\n&lt;/ul&gt;\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, id <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>, <span class="st">"&lt;ul id=\"x\"&gt;\n  &lt;li&gt;a&lt;/li&gt;\n&lt;/ul&gt;\n"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes 🥇</span>.</span></span></code></pre></div>
<p>This is a great place to use snapshot testing. To do this we make two
changes to our code:</p>
<ul>
<li><p>We use <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> instead of
<code><a href="../reference/equality-expectations.html">expect_equal()</a></code></p></li>
<li><p>We wrap the call in <code><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat()</a></code> (to avoid <code>[1]</code>
in the output, like in the first interactive example above).</p></li>
</ul>
<p>This yields the following test:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: bullets</span> ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   cat(bullets("a"))</span></span>
<span><span class="co">#&gt; Output</span></span>
<span><span class="co">#&gt;   &lt;ul&gt;</span></span>
<span><span class="co">#&gt;     &lt;li&gt;a&lt;/li&gt;</span></span>
<span><span class="co">#&gt;   &lt;/ul&gt;</span></span>
<span><span class="co">#&gt; ── <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: bullets</span> ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   cat(bullets("a", "b"))</span></span>
<span><span class="co">#&gt; Output</span></span>
<span><span class="co">#&gt;   &lt;ul id="b"&gt;</span></span>
<span><span class="co">#&gt;     &lt;li&gt;a&lt;/li&gt;</span></span>
<span><span class="co">#&gt;   &lt;/ul&gt;</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes 🎊</span>.</span></span></code></pre></div>
<p>When we run the test for the first time, it automatically generates
reference output and prints it, so that you can visually confirm that
it’s correct. The output is automatically saved in
<code>_snaps/{name}.md</code>. The name of the snapshot matches your
test file name — e.g. if your test is <code>test-pizza.R</code> then
your snapshot will be saved in
<code>tests/testthat/_snaps/pizza.md</code>. As the file name suggests,
this is a markdown file, which I’ll explain shortly.</p>
<p>If you run the test again, it’ll succeed:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes 🌈</span>.</span></span></code></pre></div>
<p>But if you change the underlying code, say to tweak the indenting,
the test will fail:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bullets</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span>, <span class="va">id</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"&lt;ul"</span>, <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">" id=\""</span>, <span class="va">id</span>, <span class="st">"\""</span><span class="op">)</span>, <span class="st">"&gt;\n"</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"&lt;li&gt;"</span>, <span class="va">text</span>, <span class="st">"&lt;/li&gt;\n"</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>    <span class="st">"&lt;/ul&gt;\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BBBB00; font-weight: bold;">Failure</span><span style="font-weight: bold;">: bullets</span> ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Snapshot of code has changed:</span></span>
<span><span class="co">#&gt;     old                 | new                    </span></span>
<span><span class="co">#&gt; [2] <span style="color: #555555;">  cat(bullets("a"))</span> | <span style="color: #555555;">  cat(bullets("a"))</span> [2]</span></span>
<span><span class="co">#&gt; [3] <span style="color: #555555;">Output</span>              | <span style="color: #555555;">Output</span>              [3]</span></span>
<span><span class="co">#&gt; [4] <span style="color: #555555;">  &lt;ul&gt;</span>              | <span style="color: #555555;">  &lt;ul&gt;</span>              [4]</span></span>
<span><span class="co">#&gt; [5] <span style="color: #00BB00;">    &lt;li&gt;a&lt;/li&gt;</span>      - <span style="color: #00BB00;">  &lt;li&gt;a&lt;/li&gt;</span>        [5]</span></span>
<span><span class="co">#&gt; [6] <span style="color: #555555;">  &lt;/ul&gt;</span>             | <span style="color: #555555;">  &lt;/ul&gt;</span>             [6]</span></span>
<span><span class="co">#&gt; * Run `testthat::snapshot_accept("snapshotting.Rmd")` to accept the change.</span></span>
<span><span class="co">#&gt; * Run `testthat::snapshot_review("snapshotting.Rmd")` to review the change.</span></span>
<span><span class="co">#&gt; ── <span style="color: #BBBB00; font-weight: bold;">Failure</span><span style="font-weight: bold;">: bullets</span> ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Snapshot of code has changed:</span></span>
<span><span class="co">#&gt;     old                      | new                         </span></span>
<span><span class="co">#&gt; [2] <span style="color: #555555;">  cat(bullets("a", "b"))</span> | <span style="color: #555555;">  cat(bullets("a", "b"))</span> [2]</span></span>
<span><span class="co">#&gt; [3] <span style="color: #555555;">Output</span>                   | <span style="color: #555555;">Output</span>                   [3]</span></span>
<span><span class="co">#&gt; [4] <span style="color: #555555;">  &lt;ul id="b"&gt;</span>            | <span style="color: #555555;">  &lt;ul id="b"&gt;</span>            [4]</span></span>
<span><span class="co">#&gt; [5] <span style="color: #00BB00;">    &lt;li&gt;a&lt;/li&gt;</span>           - <span style="color: #00BB00;">  &lt;li&gt;a&lt;/li&gt;</span>             [5]</span></span>
<span><span class="co">#&gt; [6] <span style="color: #555555;">  &lt;/ul&gt;</span>                  | <span style="color: #555555;">  &lt;/ul&gt;</span>                  [6]</span></span>
<span><span class="co">#&gt; * Run `testthat::snapshot_accept("snapshotting.Rmd")` to accept the change.</span></span>
<span><span class="co">#&gt; * Run `testthat::snapshot_review("snapshotting.Rmd")` to review the change.</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Test failed with 2 failures and 0 successes.</span></span></code></pre></div>
<p>If this is a deliberate change, you can follow the advice in the
message and update the snapshots for that file by running
<code>snapshot_accept("pizza")</code>; otherwise, you can fix the bug
and your tests will pass once more. (You can also accept snapshots for
all files with <code><a href="../reference/snapshot_accept.html">snapshot_accept()</a></code>.)</p>
<p>If you delete the test, the corresponding snapshot will be removed
the next time you run the tests. If you delete all snapshots in the
file, the entire snapshot file will be deleted the next time you run all
the tests.</p>
<div class="section level3">
<h3 id="snapshot-format">Snapshot format<a class="anchor" aria-label="anchor" href="#snapshot-format"></a>
</h3>
<p>Snapshots are recorded using a subset of markdown. You might wonder
why we use markdown. We use it because it’s important that snapshots be
human-readable because humans have to read them during code reviews.
Reviewers often don’t run your code but still want to understand the
changes.</p>
<p>Here’s the snapshot file generated by the test above:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode md"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu"># bullets</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="in">    &lt;ul&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="in">      &lt;li&gt;a&lt;/li&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="in">    &lt;/ul&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  </span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>---</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="in">    &lt;ul id="x"&gt;</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="in">      &lt;li&gt;a&lt;/li&gt;</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="in">    &lt;/ul&gt;</span></span></code></pre></div>
<p>Each test starts with <code># {test name}</code>, a level 1 heading.
Within a test, each snapshot expectation is indented by four spaces,
i.e., as code, and they are separated by <code>---</code>, a horizontal
rule.</p>
</div>
<div class="section level3">
<h3 id="interactive-usage">Interactive usage<a class="anchor" aria-label="anchor" href="#interactive-usage"></a>
</h3>
<p>Because the snapshot output uses the name of the current test file
and the current test, snapshot expectations don’t really work when run
interactively at the console. Since they can’t automatically find the
reference output, they instead just print the current value for manual
inspection.</p>
</div>
</div>
<div class="section level2">
<h2 id="testing-errors">Testing errors<a class="anchor" aria-label="anchor" href="#testing-errors"></a>
</h2>
<p>So far we’ve focused on snapshot tests for output printed to the
console. But <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> also captures messages,
errors, and warnings[^1]. Messages and warnings are straightforward, but
capturing errors is <em>slightly</em> more difficult because
<code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> will fail if there’s an error:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"you can't add a number and a letter"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="st">"a"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">: you can't add a number and a letter</span> ─────────────────────────</span></span>
<span><span class="co">#&gt; Error in `1 + "a"`: non-numeric argument to binary operator</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Backtrace:</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">    </span>▆</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 1. </span>└─<span style="font-weight: bold;">testthat</span>::expect_snapshot(1 + "a")</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 2. </span>  └─testthat:::expect_snapshot_(...)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 3. </span>    └─<span style="font-weight: bold;">rlang</span>::cnd_signal(state$error)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Test failed with 1 failure and 0 successes.</span></span></code></pre></div>
<p>This is a safety valve that ensures that you don’t accidentally write
broken code. To deliberately snapshot an error, you’ll have to
specifically request it with <code>error = TRUE</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"you can't add a number and a letter"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="st">"a"</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: you can't add a number and a letter</span> ───────────────────────</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   1 + "a"</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `1 + "a"`:</span></span>
<span><span class="co">#&gt;   ! non-numeric argument to binary operator</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 1 success 🎊</span>.</span></span></code></pre></div>
<p>When the code gets longer, I like to put <code>error = TRUE</code> up
front so it’s a little more obvious:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"you can't add weird things"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span>error <span class="op">=</span> <span class="cn">TRUE</span>, <span class="op">{</span></span>
<span>    <span class="fl">1</span> <span class="op">+</span> <span class="st">"a"</span></span>
<span>    <span class="va">mtcars</span> <span class="op">+</span> <span class="va">iris</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: you can't add weird things</span> ────────────────────────────────</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   1 + "a"</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `1 + "a"`:</span></span>
<span><span class="co">#&gt;   ! non-numeric argument to binary operator</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   mtcars + iris</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `Ops.data.frame()`:</span></span>
<span><span class="co">#&gt;   ! '+' only defined for equally-sized data frames</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   Sys.Date() + factor()</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Warning:</span></span>
<span><span class="co">#&gt;   Incompatible methods ("+.Date", "Ops.factor") for "+"</span></span>
<span><span class="co">#&gt; Output</span></span>
<span><span class="co">#&gt;   numeric(0)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 1 success 🥇</span>.</span></span></code></pre></div>
<p>Just be careful: when you set <code>error = TRUE</code>,
<code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> checks that at least one expression
throws an error, not that every expression throws an error. For example,
look above and notice that adding a date and a factor generated a
warning, not an error.</p>
<p>Snapshot tests are particularly important when testing complex error
messages, such as those that you might generate with cli. Here’s a more
realistic example illustrating how you might test
<code>check_unnamed()</code>, a function that ensures all arguments in
<code>...</code> are unnamed.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">check_unnamed</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">call</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dots.html" class="external-link">...names</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">has_name</span> <span class="op">&lt;-</span> <span class="va">names</span> <span class="op">!=</span> <span class="st">""</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">has_name</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">named</span> <span class="op">&lt;-</span> <span class="va">names</span><span class="op">[</span><span class="va">has_name</span><span class="op">]</span></span>
<span>  <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_abort</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"All elements of {.arg ...} must be unnamed."</span>,</span>
<span>      i <span class="op">=</span> <span class="st">"You supplied argument{?s} {.arg {named}}."</span></span>
<span>    <span class="op">)</span>, </span>
<span>    call <span class="op">=</span> <span class="va">call</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"no errors if all arguments unnamed"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_no_error.html">expect_no_error</a></span><span class="op">(</span><span class="fu">check_unnamed</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_no_error.html">expect_no_error</a></span><span class="op">(</span><span class="fu">check_unnamed</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes 🎉</span>.</span></span>
<span></span>
<span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"actionable feedback if some or all arguments named"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span>error <span class="op">=</span> <span class="cn">TRUE</span>, <span class="op">{</span></span>
<span>    <span class="fu">check_unnamed</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="fu">check_unnamed</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span>, y <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: actionable feedback if some or all arguments named</span> ────────</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   check_unnamed(x = 1, 2)</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error:</span></span>
<span><span class="co">#&gt;   ! All elements of `...` must be unnamed.</span></span>
<span><span class="co">#&gt;   i You supplied argument `x`.</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   check_unnamed(x = 1, y = 2)</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error:</span></span>
<span><span class="co">#&gt;   ! All elements of `...` must be unnamed.</span></span>
<span><span class="co">#&gt;   i You supplied arguments `x` and `y`.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 1 success 🎊</span>.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="other-challenges">Other challenges<a class="anchor" aria-label="anchor" href="#other-challenges"></a>
</h2>
<div class="section level3">
<h3 id="varying-outputs">Varying outputs<a class="anchor" aria-label="anchor" href="#varying-outputs"></a>
</h3>
<p>Sometimes part of the output varies in ways that you can’t easily
control. In many cases, it’s convenient to use mocking
(<code><a href="../articles/mocking.html">vignette("mocking")</a></code>) to ensure that every run of the
function always produces the same output. In other cases, it’s easier to
manipulate the text output with a regular expression or similar. That’s
the job of the <code>transform</code> argument, which should be passed a
function that takes a character vector of lines and returns a modified
vector.</p>
<p>This type of problem often crops up when you are testing a function
that gives feedback about a path. In your tests, you’ll typically use a
temporary path (e.g., from <code><a href="https://withr.r-lib.org/reference/with_tempfile.html" class="external-link">withr::local_tempfile()</a></code>), so if
you display the path in a snapshot, it will be different every time. For
example, consider this “safe” version of <code><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines()</a></code> that
requires you to explicitly opt in to overwriting an existing file:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">safe_write_lines</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lines</span>, <span class="va">path</span>, <span class="va">overwrite</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="va">overwrite</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_abort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"{.path {path}} already exists."</span>, </span>
<span>      i <span class="op">=</span> <span class="st">"Set {.code overwrite = TRUE} to overwrite"</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">lines</span>, <span class="va">path</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If you use a snapshot test to confirm that the error message is
useful, the snapshot will be different every time the test is run:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"generates actionable error message"</span>, <span class="op">{</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_tempfile.html" class="external-link">local_tempfile</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu">safe_write_lines</span><span class="op">(</span><span class="va">letters</span>, <span class="va">path</span><span class="op">)</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: generates actionable error message</span> ────────────────────────</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   safe_write_lines(letters, path)</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `safe_write_lines()`:</span></span>
<span><span class="co">#&gt;   ! '/tmp/RtmpKvl9pA/file2b22452ab264' already exists.</span></span>
<span><span class="co">#&gt;   i Set `overwrite = TRUE` to overwrite</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 1 success 🎊</span>.</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"generates actionable error message"</span>, <span class="op">{</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_tempfile.html" class="external-link">local_tempfile</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu">safe_write_lines</span><span class="op">(</span><span class="va">letters</span>, <span class="va">path</span><span class="op">)</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BBBB00; font-weight: bold;">Failure</span><span style="font-weight: bold;">: generates actionable error message</span> ────────────────────────</span></span>
<span><span class="co">#&gt; Snapshot of code has changed:</span></span>
<span><span class="co">#&gt; old[2:6] vs new[2:6]</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">    safe_write_lines(letters, path)</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  Condition</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">    Error in `safe_write_lines()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">-   ! '/tmp/RtmpKvl9pA/file2b22452ab264' already exists.</span></span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">+   ! '/tmp/RtmpKvl9pA/file2b222d45587' already exists.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">    i Set `overwrite = TRUE` to overwrite</span></span></span>
<span><span class="co">#&gt; * Run `testthat::snapshot_accept("snapshotting.Rmd")` to accept the change.</span></span>
<span><span class="co">#&gt; * Run `testthat::snapshot_review("snapshotting.Rmd")` to review the change.</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Test failed with 1 failure and 0 successes.</span></span></code></pre></div>
<p>One way to fix this problem is to use the <code>transform</code>
argument to replace the temporary path with a fixed value:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"generates actionable error message"</span>, <span class="op">{</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_tempfile.html" class="external-link">local_tempfile</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span></span>
<span>    <span class="fu">safe_write_lines</span><span class="op">(</span><span class="va">letters</span>, <span class="va">path</span><span class="op">)</span>, </span>
<span>    error <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    transform <span class="op">=</span> \<span class="op">(</span><span class="va">lines</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"&lt;path&gt;"</span>, <span class="va">lines</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: generates actionable error message</span> ────────────────────────</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   safe_write_lines(letters, path)</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `safe_write_lines()`:</span></span>
<span><span class="co">#&gt;   ! '&lt;path&gt;' already exists.</span></span>
<span><span class="co">#&gt;   i Set `overwrite = TRUE` to overwrite</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 1 success 🎊</span>.</span></span></code></pre></div>
<p>Now even though the path varies, the snapshot does not.</p>
</div>
<div class="section level3">
<h3 id="local_reproducible_output">
<code>local_reproducible_output()</code><a class="anchor" aria-label="anchor" href="#local_reproducible_output"></a>
</h3>
<p>By default, testthat sets a number of options that simplify and
standardize output:</p>
<ul>
<li>The console width is set to 80.</li>
<li>{cli} ANSI coloring and hyperlinks are suppressed.</li>
<li>Unicode characters are suppressed.</li>
</ul>
<p>These are sound defaults that we have found useful to minimize
spurious differences between tests run in different environments.
However, there are times when you want to deliberately test different
widths, ANSI escapes, or Unicode characters, so you can override the
defaults with <code><a href="../reference/local_test_context.html">local_reproducible_output()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="snapshotting-graphics">Snapshotting graphics<a class="anchor" aria-label="anchor" href="#snapshotting-graphics"></a>
</h3>
<p>If you need to test graphical output, use {vdiffr}. vdiffr is used to
test ggplot2 and incorporates everything we know about high-quality
graphics tests that minimize false positives. Graphics testing is still
often fragile, but using vdiffr means you will avoid all the problems we
know how to avoid.</p>
</div>
<div class="section level3">
<h3 id="snapshotting-values">Snapshotting values<a class="anchor" aria-label="anchor" href="#snapshotting-values"></a>
</h3>
<p><code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> is the most used snapshot function
because it records everything: the code you run, printed output,
messages, warnings, and errors. If you care about the return value
rather than any side effects, you might want to use
<code><a href="../reference/expect_snapshot_value.html">expect_snapshot_value()</a></code> instead. It offers a number of
serialization approaches that provide a tradeoff between accuracy and
human readability.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"can snapshot a simple list"</span>, <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"elephant"</span>, <span class="st">"banana"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot_value.html">expect_snapshot_value</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: can snapshot a simple list</span> ────────────────────────────────</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "a": [</span></span>
<span><span class="co">#&gt;     1,</span></span>
<span><span class="co">#&gt;     5,</span></span>
<span><span class="co">#&gt;     10</span></span>
<span><span class="co">#&gt;   ],</span></span>
<span><span class="co">#&gt;   "b": [</span></span>
<span><span class="co">#&gt;     "elephant",</span></span>
<span><span class="co">#&gt;     "banana"</span></span>
<span><span class="co">#&gt;   ]</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 1 success 🌈</span>.</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="whole-file-snapshotting">Whole file snapshotting<a class="anchor" aria-label="anchor" href="#whole-file-snapshotting"></a>
</h2>
<p><code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code>,
<code><a href="../reference/expect_snapshot_output.html">expect_snapshot_output()</a></code>,
<code><a href="../reference/expect_snapshot_output.html">expect_snapshot_error()</a></code>, and
<code><a href="../reference/expect_snapshot_value.html">expect_snapshot_value()</a></code> use one snapshot file per test
file. But that doesn’t work for all file types—for example, what happens
if you want to snapshot an image? <code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file()</a></code>
provides an alternative workflow that generates one snapshot per
expectation, rather than one file per test. Assuming you’re in
<code>test-burger.R</code>, then the snapshot created by
<code>expect_snapshot_file(code_that_returns_path_to_file(), "toppings.png")</code>
would be saved in
<code>tests/testthat/_snaps/burger/toppings.png</code>. If a future
change in the code creates a different file, it will be saved in
<code>tests/testthat/_snaps/burger/toppings.new.png</code>.</p>
<p>Unlike <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> and friends,
<code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file()</a></code> can’t provide an automatic diff when
the test fails. Instead, you’ll need to call
<code><a href="../reference/snapshot_accept.html">snapshot_review()</a></code>. This launches a Shiny app that allows
you to visually review each change and approve it if it’s
deliberate:</p>
<p><img src="review-image.png" alt="Screenshot of the Shiny app for reviewing snapshot changes to images. It shows the changes to a png file of a plot created in a snapshot test. There is a button to accept the changed snapshot, or to skip it."></p>
<p><img src="review-text.png" alt="Screenshot of the Shiny app for reviewing snapshot changes to text files. It shows the changes to a .R file created in a snapshot test, where a line has been removed. There is a button to accept the changed snapshot, or to skip it."></p>
<p>The display varies based on the file type (currently text files,
common image files, and csv files are supported).</p>
<p>Sometimes the failure occurs in a non-interactive environment where
you can’t run <code><a href="../reference/snapshot_accept.html">snapshot_review()</a></code>, e.g., in
<code>R CMD check</code>. In this case, the easiest fix is to retrieve
the <code>.new</code> file, copy it into the appropriate directory, and
then run <code><a href="../reference/snapshot_accept.html">snapshot_review()</a></code> locally. If this happens on
GitHub, testthat provides some tools to help you in the form of
<code>gh_download_artifact()</code>.</p>
<p>In most cases, we don’t expect you to use
<code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file()</a></code> directly. Instead, you’ll use it via
a wrapper that does its best to gracefully skip tests when differences
in platform or package versions make it unlikely to generate perfectly
reproducible output. That wrapper should also typically call
<code><a href="../reference/expect_snapshot_file.html">announce_snapshot_file()</a></code> to avoid snapshots being
incorrectly cleaned up—see the documentation for more details.</p>
</div>
<div class="section level2">
<h2 id="previous-work">Previous work<a class="anchor" aria-label="anchor" href="#previous-work"></a>
</h2>
<p>This is not the first time that testthat has attempted to provide
snapshot testing (although it’s the first time I knew what other
languages called them). This section describes some of the previous
attempts and why we believe the new approach is better.</p>
<ul>
<li>
<p><code><a href="../reference/verify_output.html">verify_output()</a></code> has three main drawbacks:</p>
<ul>
<li><p>You have to supply a path where the output will be saved. This
seems like a small issue, but thinking of a good name, and managing the
difference between interactive and test-time paths introduces a
surprising amount of friction.</p></li>
<li><p>It always overwrites the previous result, automatically assuming
that the changes are correct. That means you have to use it with git,
and it’s easy to accidentally accept unwanted changes.</p></li>
<li><p>It’s relatively coarse grained, which means tests that use it
tend to keep growing and growing.</p></li>
</ul>
</li>
<li><p><code><a href="../reference/expect_known_output.html">expect_known_output()</a></code> is a finer-grained version of
<code><a href="../reference/verify_output.html">verify_output()</a></code> that captures output from a single
function. The requirement to produce a path for each individual
expectation makes it even more painful to use.</p></li>
<li><p><code><a href="../reference/expect_known_output.html">expect_known_value()</a></code> and
<code><a href="../reference/expect_known_output.html">expect_known_hash()</a></code> have all the disadvantages of
<code><a href="../reference/expect_known_output.html">expect_known_output()</a></code>, but also produce binary output,
meaning that you can’t easily review test differences in pull
requests.</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
