<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Testing challenging functions • testthat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Testing challenging functions">
<meta name="robots" content="noindex">
<script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="testthat.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">testthat</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">3.2.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Setup</h6></li>
    <li><a class="dropdown-item" href="../articles/third-edition.html">testthat 3e</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Running tests in parallel</a></li>
    <li><a class="dropdown-item" href="../articles/special-files.html">Special files</a></li>
    <li><a class="dropdown-item" href="../articles/custom-expectation.html">Custom expectations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Techniques</h6></li>
    <li><a class="dropdown-item" href="../articles/challenging-tests.html">Testing challenging functions</a></li>
    <li><a class="dropdown-item" href="../articles/mocking.html">Mocking</a></li>
    <li><a class="dropdown-item" href="../articles/skipping.html">Skipping tests</a></li>
    <li><a class="dropdown-item" href="../articles/snapshotting.html">Snapshot tests</a></li>
    <li><a class="dropdown-item" href="../articles/test-fixtures.html">Test fixtures</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/10/testthat-3-2-0/">Version 3.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/10/testthat-3-1/">Version 3.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/10/testthat-3-0-0/">Version 3.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/testthat/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Testing challenging functions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/main/vignettes/challenging-tests.Rmd" class="external-link"><code>vignettes/challenging-tests.Rmd</code></a></small>
      <div class="d-none name"><code>challenging-tests.Rmd</code></div>
    </div>

    
    
<p>This vignette is a quick reference guide for testing challenging
functions. It’s organized by problem type rather than technique, so you
can quickly skim the whole vignette, spot the problem you’re facing, and
then learn more about useful tools for solving it. In it, you’ll learn
how to overcome the following challenges:</p>
<ul>
<li>Functions with implicit inputs, like options and environment
variables.</li>
<li>Random number generators.</li>
<li>Tests that can’t be run in some environments.</li>
<li>Testing web APIs.</li>
<li>Testing graphical output.</li>
<li>User interaction.</li>
<li>User-facing text.</li>
<li>Repeated code.</li>
</ul>
<div class="section level2">
<h2 id="options-and-environment-variables">Options and environment variables<a class="anchor" aria-label="anchor" href="#options-and-environment-variables"></a>
</h2>
<p>If your function depends on options or environment variables, first
try refactoring the function to make the <a href="https://design.tidyverse.org/inputs-explicit.html" class="external-link">inputs
explicit</a>. If that’s not possible, use functions like
<code><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">withr::local_options()</a></code> or
<code><a href="https://withr.r-lib.org/reference/with_envvar.html" class="external-link">withr::local_envvar()</a></code> to temporarily change options and
environment values within a test. Learn more in
<code><a href="../articles/test-fixtures.html">vignette("test-fixtures")</a></code>.</p>
<!-- FIXME: Consider adding a brief example showing the difference between implicit and explicit approaches - this would make the recommendation more concrete -->
</div>
<div class="section level2">
<h2 id="random-numbers">Random numbers<a class="anchor" aria-label="anchor" href="#random-numbers"></a>
</h2>
<p>What happens if you want to test a function that relies on randomness
in some way? If you’re writing a random number generator, you probably
want to generate a large quantity of random numbers and then apply some
statistical test. But what if your function just happens to use a little
bit of pre-existing randomness? How do you make your tests repeatable
and reproducible? Under the hood, random number generators generate
different numbers because they update a special
<code>.Random.seed</code> variable stored in the global environment. You
can temporarily set this seed to a known value to make your random
numbers reproducible with <code><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">withr::local_seed()</a></code>, making
random numbers a special case of test fixtures
(<code><a href="../articles/test-fixtures.html">vignette("test-fixtures")</a></code>).</p>
<p>Here’s a simple example showing how you might test the basic
operation of a function that rolls a die:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dice</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"dice returns different numbers"</span>, <span class="op">{</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">local_seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">dice</span><span class="op">(</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">dice</span><span class="op">(</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">dice</span><span class="op">(</span><span class="op">)</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 3 successes 🥇</span>.</span></span></code></pre></div>
<p>Alternatively, you might want to mock
(<code><a href="../articles/mocking.html">vignette("mocking")</a></code>) the function to eliminate
randomness.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roll_three</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu">dice</span><span class="op">(</span><span class="op">)</span>, <span class="fu">dice</span><span class="op">(</span><span class="op">)</span>, <span class="fu">dice</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"three dice adds values of individual calls"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span>dice <span class="op">=</span> <span class="fu"><a href="../reference/mock_output_sequence.html">mock_output_sequence</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">roll_three</span><span class="op">(</span><span class="op">)</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 1 success 🌈</span>.</span></span></code></pre></div>
<p>When should you set the seed and when should you use mocking? As a
general rule of thumb, set the seed when you want to test the actual
random behavior, and use mocking when you want to test the logic that
uses the random results.</p>
</div>
<div class="section level2">
<h2 id="some-tests-cant-be-run-in-some-circumstances">Some tests can’t be run in some circumstances<a class="anchor" aria-label="anchor" href="#some-tests-cant-be-run-in-some-circumstances"></a>
</h2>
<p>You can skip a test without it passing or failing if you can’t or
don’t want to run it (e.g., it’s OS dependent, it only works
interactively, or it shouldn’t be tested on CRAN). Learn more in
<code><a href="../articles/skipping.html">vignette("skipping")</a></code>.</p>
</div>
<div class="section level2">
<h2 id="http-requests">HTTP requests<a class="anchor" aria-label="anchor" href="#http-requests"></a>
</h2>
<p>If you’re trying to test functions that rely on HTTP requests, we
recommend using {vcr} or {httptest2}. These packages both allow you to
interactively record HTTP responses and then later replay them in tests.
This is a specialized type of mocking (<code><a href="../articles/mocking.html">vignette("mocking")</a></code>)
that works with {httr} and {httr2} to isolates your tests from failures
in the underlying API.</p>
<p>If your package is going to CRAN, you <strong>must</strong> either
use one of these packages or use <code><a href="../reference/skip.html">skip_on_cran()</a></code> for all
internet-facing tests. Otherwise, you are at high risk of failing
<code>R CMD check</code> if the underlying API is temporarily down. This
sort of failure causes extra work for the CRAN maintainers and extra
hassle for you.</p>
</div>
<div class="section level2">
<h2 id="graphics">Graphics<a class="anchor" aria-label="anchor" href="#graphics"></a>
</h2>
<p>The only type of testing you can use for graphics is snapshot testing
(<code><a href="../articles/snapshotting.html">vignette("snapshotting")</a></code>) via
<code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file()</a></code>. Graphical snapshot testing is
surprisingly challenging because you need pixel-perfect rendering across
multiple versions of multiple operating systems, and this is hard,
mostly due to imperceptible differences in font rendering. Fortunately
we’ve needed to overcome these challenges in order to test {ggplot2},
and you can benefit from our experience by using {vdiffr} when testing
graphical output.</p>
</div>
<div class="section level2">
<h2 id="user-interaction">User interaction<a class="anchor" aria-label="anchor" href="#user-interaction"></a>
</h2>
<p>If you’re testing a function that relies on user feedback (e.g. from
<code><a href="https://rdrr.io/r/base/readline.html" class="external-link">readline()</a></code>, <code><a href="https://rdrr.io/r/utils/menu.html" class="external-link">utils::menu()</a></code>, or
<code><a href="https://rdrr.io/r/utils/askYesNo.html" class="external-link">utils::askYesNo()</a></code>), you can use mocking
(<code><a href="../articles/mocking.html">vignette("mocking")</a></code>) to return fixed values within the
test. For example, imagine that you’ve written the following function
that asks the user if they want to continue:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">continue</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prompt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">prompt</span>, <span class="st">"\n"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">repeat</span> <span class="op">{</span></span>
<span>    <span class="va">val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readline.html" class="external-link">readline</a></span><span class="op">(</span><span class="st">"Do you want to continue? (y/n) "</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">val</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"n"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">val</span> <span class="op">==</span> <span class="st">"y"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"! You must enter y or n\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">readline</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>You could test its behavior by mocking <code><a href="https://rdrr.io/r/base/readline.html" class="external-link">readline()</a></code> and
using a snapshot test:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"user must respond y or n"</span>, <span class="op">{</span></span>
<span>  <span class="va">mock_readline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">local</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">prompt</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">i</span> <span class="op">&lt;&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">prompt</span><span class="op">)</span></span>
<span>      <span class="va">val</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="st">"x"</span> <span class="kw">else</span> <span class="st">"y"</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">val</span>, <span class="st">"\n"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>      <span class="va">val</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span>readline <span class="op">=</span> <span class="va">mock_readline</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="va">val</span> <span class="op">&lt;-</span> <span class="fu">continue</span><span class="op">(</span><span class="st">"This is dangerous"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/logical-expectations.html">expect_true</a></span><span class="op">(</span><span class="va">val</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: user must respond y or n</span> ──────────────────────────────────</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   val &lt;- continue("This is dangerous")</span></span>
<span><span class="co">#&gt; Output</span></span>
<span><span class="co">#&gt;   This is dangerous</span></span>
<span><span class="co">#&gt;   Do you want to continue? (y/n) x</span></span>
<span><span class="co">#&gt;   ! You must enter y or n</span></span>
<span><span class="co">#&gt;   Do you want to continue? (y/n) y</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes 🎊</span>.</span></span></code></pre></div>
<p>If you don’t care about reproducing the output of
<code>continue()</code> and just want to recreate its return value, you
can use <code><a href="../reference/mock_output_sequence.html">mock_output_sequence()</a></code>. This creates a function
that returns the input supplied to <code><a href="../reference/mock_output_sequence.html">mock_output_sequence()</a></code>
in sequence: the first input at the first call, the second input at the
second call, etc. The following code shows how it works and how you
might use it to test <code><a href="https://rdrr.io/r/base/readline.html" class="external-link">readline()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mock_output_sequence.html">mock_output_sequence</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">12</span>, <span class="fl">123</span><span class="op">)</span></span>
<span><span class="fu">f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="fu">f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 12</span></span>
<span><span class="fu">f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 123</span></span></code></pre></div>
<p>And</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"user must respond y or n"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span>readline <span class="op">=</span> <span class="fu"><a href="../reference/mock_output_sequence.html">mock_output_sequence</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/logical-expectations.html">expect_true</a></span><span class="op">(</span><span class="fu">continue</span><span class="op">(</span><span class="st">"This is dangerous"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; This is dangerous</span></span>
<span><span class="co">#&gt; ! You must enter y or n</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 1 success 😀</span>.</span></span></code></pre></div>
<p>If you were testing the behavior of some function that uses
<code>continue()</code>, you might want to mock <code>continue()</code>
instead of <code><a href="https://rdrr.io/r/base/readline.html" class="external-link">readline()</a></code>. For example, the function below
requires user confirmation before overwriting an existing file. In order
to focus our tests on the behavior of just this function, we mock
<code>continue()</code> to return either <code>TRUE</code> or
<code>FALSE</code> without any user messaging.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">save_file</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">continue</span><span class="op">(</span><span class="st">"`path` already exists"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Failed to continue"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">path</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"save_file() requires confirmation to overwrite file"</span>, <span class="op">{</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_tempfile.html" class="external-link">local_tempfile</a></span><span class="op">(</span>lines <span class="op">=</span> <span class="va">letters</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span>continue <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">save_file</span><span class="op">(</span><span class="va">path</span>, <span class="st">"a"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span>, <span class="st">"a"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span>continue <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu">save_file</span><span class="op">(</span><span class="va">path</span>, <span class="st">"a"</span><span class="op">)</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="color: #BB00BB; font-weight: bold;">Warning</span><span style="font-weight: bold;">: save_file() requires confirmation to overwrite file</span> ───────</span></span>
<span><span class="co">#&gt; Adding new snapshot:</span></span>
<span><span class="co">#&gt; Code</span></span>
<span><span class="co">#&gt;   save_file(path, "a")</span></span>
<span><span class="co">#&gt; Condition</span></span>
<span><span class="co">#&gt;   Error in `save_file()`:</span></span>
<span><span class="co">#&gt;   ! Failed to continue</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes 🥇</span>.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="user-facing-text">User-facing text<a class="anchor" aria-label="anchor" href="#user-facing-text"></a>
</h2>
<p>Errors, warnings, and other user-facing text should be tested to
ensure they’re both actionable and consistent across the package.
Obviously, it’s not possible to test this automatically, but you can use
snapshots (<code><a href="../articles/snapshotting.html">vignette("snapshotting")</a></code>) to ensure that
user-facing messages are clearly shown in PRs and easily reviewed by
another human.</p>
</div>
<div class="section level2">
<h2 id="repeated-code">Repeated code<a class="anchor" aria-label="anchor" href="#repeated-code"></a>
</h2>
<p>If you find yourself repeating the same set of expectations again and
again across your test suite, it may be a sign that you should design
your own expectation. Learn how in
<code><a href="../articles/custom-expectation.html">vignette("custom-expectation")</a></code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
