<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Running tests in parallel • testthat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running tests in parallel">
<meta name="robots" content="noindex">
<script defer data-domain="testthat.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">testthat</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">3.2.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/custom-expectation.html">Custom expectations</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Running tests in parallel</a></li>
    <li><a class="dropdown-item" href="../articles/skipping.html">Skipping tests</a></li>
    <li><a class="dropdown-item" href="../articles/snapshotting.html">Snapshot tests</a></li>
    <li><a class="dropdown-item" href="../articles/special-files.html">Special files</a></li>
    <li><a class="dropdown-item" href="../articles/test-fixtures.html">Test fixtures</a></li>
    <li><a class="dropdown-item" href="../articles/third-edition.html">testthat 3e</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/10/testthat-3-2-0/">Version 3.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/10/testthat-3-1/">Version 3.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/10/testthat-3-0-0/">Version 3.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/testthat/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Running tests in parallel</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/main/vignettes/parallel.Rmd" class="external-link"><code>vignettes/parallel.Rmd</code></a></small>
      <div class="d-none name"><code>parallel.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>To enable parallel testing, you must first be using the 3rd edition<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;See &lt;code&gt;&lt;a href="../articles/third-edition.html"&gt;vignette("third-edition")&lt;/a&gt;&lt;/code&gt; for
details.&lt;/p&gt;'><sup>1</sup></a>. Then add
the following line to the <code>DESCRIPTION</code>:</p>
<pre><code><span><span class="va">Config</span><span class="op">/</span><span class="va">testthat</span><span class="op">/</span><span class="va">parallel</span><span class="op">:</span> <span class="va">true</span></span></code></pre>
<p>By default, testthat will use <code>getOption("Ncpus", 2)</code>
cores. To increase that value for your development machine we recommend
setting <code>TESTTHAT_CPUS</code> in your <code>.Renviron</code>. The
easiest way to do that is call <code><a href="https://usethis.r-lib.org/reference/edit.html" class="external-link">usethis::edit_r_environ()</a></code>
and then add something like the following:</p>
<pre><code><span><span class="va">TESTTHAT_CPUS</span><span class="op">=</span><span class="fl">4</span></span></code></pre>
<p>Tests are run in alphabetical order by default, but you can often
improve performance by starting the slowest tests first. Specify these
tests by supplying a comma separated list of glob patterns<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;See &lt;code&gt;&lt;a href="https://rdrr.io/r/utils/glob2rx.html" class="external-link"&gt;?utils::glob2rx&lt;/a&gt;&lt;/code&gt; for details&lt;/p&gt;'><sup>2</sup></a> to the
<code>Config/testthat/start-first</code> field in your
<code>DESCRIPTION</code>, e.g.:</p>
<pre><code>Config/testthat/start-first: watcher, parallel*</code></pre>
</div>
<div class="section level2">
<h2 id="basic-operation">Basic operation<a class="anchor" aria-label="anchor" href="#basic-operation"></a>
</h2>
<p>Each worker begins by loading testthat and the package being tested.
It then runs any setup files (so if you have existing setup files you’ll
need to make sure they work when executed in parallel).</p>
<p>testthat runs test <em>files</em> in parallel. Once the worker pool
is initialized, testthat then starts sending test files to workers, by
default in alphabetical order: as soon as a subprocess has finished, it
receives another file, until all files are done. This means that state
is persisted across test files: options are <em>not</em> reset, loaded
packages are <em>not</em> unloaded, the global environment is
<em>not</em> cleared, etc. You are responsible for making sure each file
leaves the world as it finds it.</p>
</div>
<div class="section level2">
<h2 id="common-problems">Common problems<a class="anchor" aria-label="anchor" href="#common-problems"></a>
</h2>
<ul>
<li><p>If tests fail stochastically (i.e. they sometimes work and
sometimes fail) you may have accidentally introduced a dependency
between your test files. This sort of dependency is hard to track down
due to the random nature, and you’ll need to check all tests to make
sure that they’re not accidentally changing global state.
<code><a href="../reference/set_state_inspector.html">set_state_inspector()</a></code> will make this easier.</p></li>
<li><p>If you use <a href="https://testthat.r-lib.org/articles/test-fixtures.html#package">packaged
scope test fixtures</a>, you’ll need to review them to make sure that
they work in parallel. For example, if you were previously creating a
temporary database in the test directory, you’d need to instead create
it in the session temporary directory so that each process gets its own
independent version.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="performance">Performance<a class="anchor" aria-label="anchor" href="#performance"></a>
</h2>
<p>There is some overhead associated with running tests in parallel:</p>
<ul>
<li><p>Startup cost is linear in the number of subprocesses, because we
need to create them in a loop. This is about 50ms on my laptop. Each
subprocess needs to load testthat and the tested package, this happens
in parallel, and we cannot do too much about it.</p></li>
<li><p>Clean up time is again linear in the number of subprocesses, and
it about 80ms per subprocess on my laptop.</p></li>
<li><p>It seems that sending a message (i.e. a passing or failing
expectation) is about 2ms currently. This is the total cost that
includes sending the message, receiving it, and replying it to a
non-parallel reporter.</p></li>
</ul>
<p>This overhead generally means that if you have many test files that
take a short amount of time, you’re unlikely to see a huge benefit by
using parallel tests. For example, testthat itself takes about 10s to
run tests in serial, and 8s to run the tests in parallel.</p>
</div>
<div class="section level2">
<h2 id="reporters">Reporters<a class="anchor" aria-label="anchor" href="#reporters"></a>
</h2>
<div class="section level3">
<h3 id="default-reporters">Default reporters<a class="anchor" aria-label="anchor" href="#default-reporters"></a>
</h3>
<p>See <code><a href="../reference/default_reporter.html">default_reporter()</a></code> for how testthat selects the
default reporter for <code>devtools::test()</code> and
<code><a href="../reference/test_package.html">testthat::test_local()</a></code>. In short, testthat selects
<code>ProgressReporter</code> for non-parallel and
<code>ParallelProgressReporter</code> for parallel tests by default.
(Other testthat test functions, like <code><a href="../reference/test_package.html">test_check()</a></code>,
<code><a href="../reference/test_file.html">test_file()</a></code> , etc. select different reporters by
default.)</p>
</div>
<div class="section level3">
<h3 id="parallel-support">Parallel support<a class="anchor" aria-label="anchor" href="#parallel-support"></a>
</h3>
<p>Most reporters support parallel tests. If a reporter is passed to
<code>devtools::test()</code>, <code><a href="../reference/test_dir.html">testthat::test_dir()</a></code>, etc.
directly, and it does not support parallel tests, then testthat runs the
test files sequentially.</p>
<p>Currently the following reporters <em>don’t</em> support parallel
tests:</p>
<ul>
<li><p><code>DebugReporter</code>, because it is not currently possible
to debug subprocesses.</p></li>
<li><p><code>JunitReporter</code>, because this reporter records timing
information for each test block, and this is currently only available
for reporters that support multiple active test files. (See “Writing
parallel reporters” below.)</p></li>
<li><p><code>LocationReporter</code> because testthat currently does not
include location information for successful tests when running in
parallel, to minimize messaging between the processes.</p></li>
<li><p><code>StopReporter</code>, as this is a reporter that testthat
uses for interactive <code><a href="../reference/expect_that.html">expect_that()</a></code> calls.</p></li>
</ul>
<p>The other built-in reporters all support parallel tests, with some
subtle differences:</p>
<ul>
<li><p>Reporters that stop after a certain number of failures can only
stop at the end of a test file.</p></li>
<li><p>Reporters report all information about a file at once, unless
they support <em>parallel updates</em>. E.g.
<code>ProgressReporter</code> does not update its display until a test
file is complete.</p></li>
<li>
<p>The standard output and standard error,
i.e. <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code>, <code><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat()</a></code>, <code><a href="https://rdrr.io/r/base/message.html" class="external-link">message()</a></code>,
etc. output from the test files are lost currently. If you want to use
<code><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat()</a></code> or <code><a href="https://rdrr.io/r/base/message.html" class="external-link">message()</a></code> for print-debugging test
cases, then the best is to temporarily run tests sequentially, by
changing the <code>Config</code> entry in <code>DESCRIPTION</code> or
selecting a non-parallel reporter, e.g. the
<code>CheckReporter</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">test</span><span class="op">(</span>filter <span class="op">=</span> <span class="st">"badtest"</span>, reporter <span class="op">=</span> <span class="st">"check"</span><span class="op">)</span></span></code></pre></div>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="writing-parallel-reporters">Writing parallel reporters<a class="anchor" aria-label="anchor" href="#writing-parallel-reporters"></a>
</h3>
<p>To support parallel tests, a reporter must be able to function when
the test files run in a subprocess. For example
<code>DebugReporter</code> does not support parallel tests, because it
requires direct interaction with the frames in the subprocess. When
running in parallel, testthat does not provide location information
(source references) for test successes.</p>
<p>To support parallel tests, a reporter must set
<code>self$capabilities$parallel_support</code> to <code>TRUE</code> in
its <code>initialize()</code> method:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">...</span></span>
<span><span class="va">initialize</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">capabilities</span><span class="op">$</span><span class="va">parallel_support</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span>
<span><span class="va">...</span></span></code></pre></div>
<p>When running in parallel, testthat runs the reporter in the main
process, and relays information between the reporter and the test code
transparently. (Currently the reporter does not even know that the tests
are running in parallel.)</p>
<p>If a reporter does not support parallel updates (see below), then
testthat internally caches all calls to the reporter methods from
subprocesses, until a test file is complete. This is because these
reporters are not prepared for running multiple test files concurrently.
Once a test file is complete, testthat calls the reporter’s
<code>$start_file()</code> method, relays all <code>$start_test()</code>
, <code>$end_test()</code>, <code>$add_result()</code>, etc. calls in
the order they came in from the subprocess, and calls
<code>$end_file()</code> .</p>
</div>
<div class="section level3">
<h3 id="parallel-updates">Parallel updates<a class="anchor" aria-label="anchor" href="#parallel-updates"></a>
</h3>
<p>The <code>ParallelProgressReporter</code> supports parallel updates.
This means that once a message from a subprocess comes in, the reporter
is updated immediately. For this to work, a reporter must be able to
handle multiple test files concurrently.</p>
<p>A reporter declares parallel update support by setting
<code>self$capabilities$parallel_updates</code> to
<code>TRUE</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">...</span></span>
<span><span class="va">initialize</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">capabilities</span><span class="op">$</span><span class="va">parallel_support</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">capabilities</span><span class="op">$</span><span class="va">parallel_updates</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span>
<span><span class="va">...</span></span></code></pre></div>
<p>For these reporters, testthat does not cache the messages from the
subprocesses. Instead, when a message comes in:</p>
<ul>
<li><p>It calls the <code>$start_file()</code> method, letting the
reporter know which file the following calls apply to. This means that
the reporter can receive multiple <code>$start_file()</code> calls for
the same file.</p></li>
<li><p>Then relays the message from the subprocess, calling the
appropriate <code>$start_test()</code> , <code>$add_result()</code>,
etc. method.</p></li>
</ul>
<p>testthat also calls the new <code>$update()</code> method of the
reporter regularly, even if it does not receive any messages from the
subprocess. (Currently aims to do this every 100ms, but there are no
guarantees.) The <code>$update()</code> method may implement a spinner
to let the user know that the tests are running.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>
