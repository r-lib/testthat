<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Test fixtures ‚Ä¢ testthat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="‚Äùimage/svg+xml‚Äù" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Test fixtures">
<meta name="robots" content="noindex">
<script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="testthat.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">testthat</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">3.2.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Setup</h6></li>
    <li><a class="dropdown-item" href="../articles/third-edition.html">testthat 3e</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Running tests in parallel</a></li>
    <li><a class="dropdown-item" href="../articles/special-files.html">Special files</a></li>
    <li><a class="dropdown-item" href="../articles/custom-expectation.html">Custom expectations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Techniques</h6></li>
    <li><a class="dropdown-item" href="../articles/challenging-tests.html">Testing challenging functions</a></li>
    <li><a class="dropdown-item" href="../articles/mocking.html">Mocking</a></li>
    <li><a class="dropdown-item" href="../articles/skipping.html">Skipping tests</a></li>
    <li><a class="dropdown-item" href="../articles/snapshotting.html">Snapshot tests</a></li>
    <li><a class="dropdown-item" href="../articles/test-fixtures.html">Test fixtures</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/10/testthat-3-2-0/">Version 3.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/10/testthat-3-1/">Version 3.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/10/testthat-3-0-0/">Version 3.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/testthat/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Test fixtures</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/main/vignettes/test-fixtures.Rmd" class="external-link"><code>vignettes/test-fixtures.Rmd</code></a></small>
      <div class="d-none name"><code>test-fixtures.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="test-hygiene">Test hygiene<a class="anchor" aria-label="anchor" href="#test-hygiene"></a>
</h2>
<blockquote>
<p>Take nothing but memories, leave nothing but footprints.</p>
<p>‚Äï Chief Si‚Äôahl</p>
</blockquote>
<p>Ideally, a test should leave the world exactly as it found it. But
you often need to make changes to exercise every part of your code:</p>
<ul>
<li>Create a file or directory</li>
<li>Create a resource on an external system</li>
<li>Set an R option</li>
<li>Set an environment variable</li>
<li>Change working directory</li>
<li>Change an aspect of the tested package‚Äôs state</li>
</ul>
<p>How can you clean up these changes to get back to a clean slate?
Scrupulous attention to cleanup is more than just courtesy or being
fastidious. It‚Äôs also self-serving. The state of the world after test
<code>i</code> is the starting state for test <code>i + 1</code>. Tests
that change state willy-nilly eventually end up interfering with each
other in ways that can be very difficult to debug.</p>
<p>Most tests are written with an implicit assumption about the starting
state, usually whatever <em>tabula rasa</em> means for the target domain
of your package. If you accumulate enough sloppy tests, you will
eventually find yourself asking the programming equivalent of questions
like ‚ÄúWho forgot to turn off the oven?‚Äù and ‚ÄúWho didn‚Äôt clean up after
the dog?‚Äù (If you‚Äôve got yourself into this state, testthat provides
another tool to help you figure out exactly which test is to blame:
<code><a href="../reference/set_state_inspector.html">set_state_inspector()</a></code>.)</p>
<p>It‚Äôs also important that your setup and cleanup are easy to use when
working interactively. When a test fails, you want to be able to quickly
recreate the exact environment in which the test is run so you can
interactively experiment to figure out what went wrong.</p>
<p>This article introduces a powerful technique that allows you to solve
both problems: <strong>test fixtures</strong>. We‚Äôll begin by discussing
some canned tools, then learn about the underlying theory, discuss
exactly what a test fixture is, and finish with a few examples.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="local_-helpers">
<code>local_</code> helpers<a class="anchor" aria-label="anchor" href="#local_-helpers"></a>
</h2>
<p>We‚Äôll begin by giving you the minimal knowledge needed to change
global state <em>just</em> within your test. The withr package provides
a number of functions that temporarily change the state of the world,
carefully undoing the changes when the current function or test
finishes:</p>
<table class="table">
<thead><tr class="header">
<th>Do / undo this</th>
<th>withr function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Create a file</td>
<td><code>local_tempfile()</code></td>
</tr>
<tr class="even">
<td>Create a directory</td>
<td><code>local_tempdir()</code></td>
</tr>
<tr class="odd">
<td>Set an R option</td>
<td><code>local_options()</code></td>
</tr>
<tr class="even">
<td>Set an environment variable</td>
<td><code>local_envvar()</code></td>
</tr>
<tr class="odd">
<td>Change working directory</td>
<td><code>local_dir()</code></td>
</tr>
</tbody>
</table>
<p>(You can see a full list at <a href="https://withr.r-lib.org/" class="external-link uri">https://withr.r-lib.org/</a> but these five are by far the
most commonly used.)</p>
<p>These allow you to control options that would otherwise be painful.
For example, imagine you‚Äôre testing base R code that rounds numbers to a
fixed number of places when printing. You could write code like
this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"print() respects digits option"</span>, <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1.23456789</span></span>
<span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">local_options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="st">"[1] 1"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">local_options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="st">"[1] 1.2346"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes ü•á</span>.</span></span></code></pre></div>
<p>If you write a lot of code like this in your tests, you might decide
you want a helper function or <strong>test fixture</strong> that reduces
the duplication. Fortunately withr‚Äôs local functions allow us to solve
this problem by providing an <code>.local_envir</code> or
<code>envir</code> argument that controls when cleanup occurs. The exact
details of how this works are rather complicated, but fortunately
there‚Äôs a common pattern you can use without understanding all the
details. Your helper function should always have an <code>env</code>
argument that defaults to <code><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame()</a></code>, which you pass to
the <code>.local_envir</code> argument of <code>local_()</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">local_digits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sig_digits</span>, <span class="va">env</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">local_options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span>, .local_envir <span class="op">=</span> <span class="va">env</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># mark that this function is called for its side-effects not its return value</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="foundations">Foundations<a class="anchor" aria-label="anchor" href="#foundations"></a>
</h2>
<p>Before we go further, let‚Äôs lay some foundations to help you
understand how <code>local_</code> functions work. We‚Äôll motivate the
discussion with a <code>sloppy()</code> function that prints a number
with a specific number of significant digits by adjusting an R
option:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sloppy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pi</span></span>
<span><span class="co">#&gt; [1] 3.141593</span></span>
<span><span class="fu">sloppy</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.1</span></span>
<span><span class="va">pi</span></span>
<span><span class="co">#&gt; [1] 3.1</span></span></code></pre></div>
<p>Notice how <code>pi</code> prints differently before and after the
call to <code>sloppy()</code>. Calling <code>sloppy()</code> has a side
effect: it changes the <code>digits</code> option globally, not just
within its own scope. This is what we want to avoid<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Don‚Äôt worry, I‚Äôm restoring global state (specifically,
the &lt;code&gt;digits&lt;/code&gt; option) behind the scenes here.&lt;/p&gt;"><sup>1</sup></a>.</p>
<div class="section level3">
<h3 id="on-exit">
<code>on.exit()</code><a class="anchor" aria-label="anchor" href="#on-exit"></a>
</h3>
<p>The first function you need to know about is base R‚Äôs
<code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>. <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> calls the code supplied
to its first argument when the current function exits, regardless of
whether it returns a value or throws an error. You can use
<code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> to clean up after yourself by ensuring that every
mess-making function call is paired with an <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> call
that cleans up.</p>
<p>We can use this idea to turn <code>sloppy()</code> into
<code>neat()</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">neat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, after <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pi</span></span>
<span><span class="co">#&gt; [1] 3.141593</span></span>
<span><span class="fu">neat</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.1</span></span>
<span><span class="va">pi</span></span>
<span><span class="co">#&gt; [1] 3.141593</span></span></code></pre></div>
<p>Here we make use of a useful pattern that <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options()</a></code>
implements: when you call <code>options(digits = sig_digits)</code>, it
both sets the <code>digits</code> option <em>and</em> (invisibly)
returns the previous value of digits. We can then use that value to
restore the previous options.</p>
<p><code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> also works in tests:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"can print one digit of pi"</span>, <span class="op">{</span></span>
<span>  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, after <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="../reference/expect_output.html">expect_output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">pi</span><span class="op">)</span>, <span class="st">"3"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 1 success üéä</span>.</span></span>
<span><span class="va">pi</span></span>
<span><span class="co">#&gt; [1] 3.141593</span></span></code></pre></div>
<p>There are three main drawbacks to <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>:</p>
<ul>
<li><p>You should always call it with <code>add = TRUE</code> and
<code>after = FALSE</code>. These ensure that the call is
<strong>added</strong> to the list of deferred tasks (instead of
replacing them) and is added to the <strong>front</strong> of the stack
(not the back), so that cleanup occurs in reverse order to setup. These
arguments only matter if you‚Äôre using multiple <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>
calls, but it‚Äôs a good habit to always use them to avoid potential
problems down the road.</p></li>
<li>
<p>It doesn‚Äôt work outside a function or test. If you run the
following code in the global environment, you won‚Äôt get an error, but
the cleanup code will never be run:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, after <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>This is annoying when you are running tests interactively.</p>
</li>
<li><p>You can‚Äôt program with it; <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> always works
inside the <em>current</em> function, so you can‚Äôt wrap up repeated
<code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> code in a helper function.</p></li>
</ul>
<p>To resolve these drawbacks, we use <code><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">withr::defer()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="withrdefer">
<code>withr::defer()</code><a class="anchor" aria-label="anchor" href="#withrdefer"></a>
</h3>
<p><code><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">withr::defer()</a></code> resolves the main drawbacks of
<code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>. First, it has the behavior we want by default;
no extra arguments needed:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">neat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Second, it works when called in the global environment. Since the
global environment isn‚Äôt perishable, like a test environment is, you
have to call <code>deferred_run()</code> explicitly to execute the
deferred events. You can also clear them, without running, with
<code>deferred_clear()</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"hi"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Setting deferred event(s) on global environment.</span></span>
<span><span class="co">#&gt;   * Execute (and clear) with `deferred_run()`.</span></span>
<span><span class="co">#&gt;   * Clear (without executing) with `deferred_clear()`.</span></span>
<span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">deferred_run</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "hi"</span></span></code></pre></div>
<p>Finally, <code><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">withr::defer()</a></code> lets you pick which function to
bind the cleanup behavior to. This makes it possible to create helper
functions.</p>
</div>
<div class="section level3">
<h3 id="local-helpers">‚ÄúLocal‚Äù helpers<a class="anchor" aria-label="anchor" href="#local-helpers"></a>
</h3>
<p>Imagine we have many functions where we want to temporarily set the
digits option. Wouldn‚Äôt it be nice if we could write a helper function
to automate this? Unfortunately, we can‚Äôt write a helper with
<code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">local_digits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, after <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">neater</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">local_digits</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">neater</span><span class="op">(</span><span class="va">pi</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.141593</span></span></code></pre></div>
<p>This code doesn‚Äôt work because the cleanup happens too soon, when
<code>local_digits()</code> exits, not when <code>neater()</code>
finishes.</p>
<p>Fortunately, <code><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">withr::defer()</a></code> allows us to solve this
problem by providing an <code>envir</code> argument that allows you to
control when cleanup occurs. The exact details of how this works are
rather complicated, but fortunately there‚Äôs a common pattern you can use
without understanding all the details. Your helper function should
always have an <code>env</code> argument that defaults to
<code><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame()</a></code>, which you pass to the second argument of
<code>defer()</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">local_digits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sig_digits</span>, <span class="va">env</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, <span class="va">env</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">neater</span><span class="op">(</span><span class="va">pi</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>Just like <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> and <code>defer()</code>, our helper
also works within tests:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"withr lets us write custom helpers for local state manipulation"</span>, <span class="op">{</span></span>
<span>  <span class="fu">local_digits</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_output.html">expect_output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="st">"3"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">local_digits</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_output.html">expect_output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="st">"2.72"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes üåà</span>.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2.718282</span></span></code></pre></div>
<p>We always call these helper functions <code>local_*</code>; ‚Äúlocal‚Äù
here refers to the fact that the state change persists only locally, for
the lifetime of the associated function or test. Another reason we call
them ‚Äúlocal‚Äù is that you can also use the <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">local()</a></code> function
if you want to scope their effect to a smaller part of the test:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"local_options() only affects a minimal amount of code"</span>, <span class="op">{</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">local_options</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">local</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">local_options</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 3 successes üéä</span>.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="test-fixtures">Test fixtures<a class="anchor" aria-label="anchor" href="#test-fixtures"></a>
</h2>
<p>Testing is often demonstrated with cute little tests and functions
where all the inputs and expected results can be inlined. But in real
packages, things aren‚Äôt always so simple, and functions often depend on
global state. For example, take this variant on <code><a href="https://rdrr.io/r/base/message.html" class="external-link">message()</a></code>
that only shows a message if the <code>verbose</code> option is
<code>TRUE</code>. How would you test that setting the option does
indeed silence the message?</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">message2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"verbose"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In some cases, it‚Äôs possible to make the global state an explicit
argument to the function. For example, we could refactor
<code>message2()</code> to make the verbosity an explicit argument:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">message3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">verbose</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"verbose"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">verbose</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Making external state explicit is often worthwhile because it makes
clearer exactly what inputs determine the outputs of your function. But
it‚Äôs simply not possible in many cases. That‚Äôs where test fixtures come
in: they allow you to temporarily change global state to test your
function. Test fixture is a pre-existing term in the software
engineering world (and beyond):</p>
<blockquote>
<p>A test fixture is something used to consistently test some item,
device, or piece of software.</p>
<p>‚Äî <a href="https://en.wikipedia.org/wiki/Test_fixture" class="external-link">Wikipedia</a></p>
</blockquote>
<p>A <strong>test fixture</strong> is just a <code>local_*</code>
function that you use to change state in such a way that you can reach
inside and test parts of your code that would otherwise be challenging.
For example, here‚Äôs how you could use
<code><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">withr::local_options()</a></code> as a test fixture to test
<code>message2()</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"message2() output depends on verbose option"</span>, <span class="op">{</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">local_options</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_error.html">expect_message</a></span><span class="op">(</span><span class="fu">message2</span><span class="op">(</span><span class="st">"Hi!"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html" class="external-link">local_options</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/expect_error.html">expect_message</a></span><span class="op">(</span><span class="fu">message2</span><span class="op">(</span><span class="st">"Hi!"</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; now dyn.load("/home/runner/work/_temp/Library/glue/libs/glue.so") ...</span></span>
<span><span class="co">#&gt; now dyn.load("/home/runner/work/_temp/Library/vctrs/libs/vctrs.so") ...</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Test passed with 2 successes ü•á</span>.</span></span></code></pre></div>
<div class="section level3">
<h3 id="case-study-usethis">Case study: usethis<a class="anchor" aria-label="anchor" href="#case-study-usethis"></a>
</h3>
<p>One place that we use test fixtures extensively is in the usethis
package (<a href="https://usethis.r-lib.org" class="external-link">usethis.r-lib.org</a>),
which provides functions for looking after the files and folders in R
projects, especially packages. Many of these functions only make sense
in the context of a package, which means to test them, we also have to
be working inside an R package. We need a way to quickly spin up a
minimal package in a temporary directory, then test some functions
against it, then destroy it.</p>
<p>To solve this problem we create a test fixture, which we place in
<code>R/test-helpers.R</code> so that it‚Äôs available for both testing
and interactive experimentation:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">local_create_package</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dir</span> <span class="op">=</span> <span class="fu">file_temp</span><span class="op">(</span><span class="op">)</span>, <span class="va">env</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">old_project</span> <span class="op">&lt;-</span> <span class="fu">proj_get_</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create new folder and package</span></span>
<span>  <span class="fu">create_package</span><span class="op">(</span><span class="va">dir</span>, open <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># A</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">defer</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/delete.html" class="external-link">dir_delete</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span>, envir <span class="op">=</span> <span class="va">env</span><span class="op">)</span> <span class="co"># -A</span></span>
<span>  </span>
<span>  <span class="co"># change working directory</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_dir.html" class="external-link">local_dir</a></span><span class="op">(</span><span class="va">dir</span>, .local_envir <span class="op">=</span> <span class="va">env</span><span class="op">)</span> <span class="co"># B + -B</span></span>
<span>  </span>
<span>  <span class="co"># switch to new usethis project</span></span>
<span>  <span class="fu">proj_set</span><span class="op">(</span><span class="va">dir</span><span class="op">)</span> <span class="co"># C</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">defer</a></span><span class="op">(</span><span class="fu">proj_set</span><span class="op">(</span><span class="va">old_project</span>, force <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, envir <span class="op">=</span> <span class="va">env</span><span class="op">)</span> <span class="co"># -C</span></span>
<span>  </span>
<span>  <span class="va">dir</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that the cleanup automatically unfolds in the opposite order
from the setup. Setup is <code>A</code>, then <code>B</code>, then
<code>C</code>; cleanup is <code>-C</code>, then <code>-B</code>, then
<code>-A</code>. This is important because we must create directory
<code>dir</code> before we can make it the working directory, and we
must restore the original working directory before we can delete
<code>dir</code>‚Äîwe can‚Äôt delete <code>dir</code> while it‚Äôs still the
working directory!</p>
<p><code>local_create_package()</code> is used in over 170 tests. Here‚Äôs
one example that checks that <code><a href="https://usethis.r-lib.org/reference/use_roxygen_md.html" class="external-link">usethis::use_roxygen_md()</a></code> does
the setup necessary to use roxygen2 in a package, with markdown support
turned on. All 3 expectations consult the DESCRIPTION file, directly or
indirectly. So it‚Äôs very convenient that
<code>local_create_package()</code> creates a minimal package, with a
valid <code>DESCRIPTION</code> file, for us to test against. And when
the test is done ‚Äî poof! ‚Äî the package is gone.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"use_roxygen_md() adds DESCRIPTION fields"</span>, <span class="op">{</span></span>
<span>  <span class="va">pkg</span> <span class="op">&lt;-</span> <span class="fu">local_create_package</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">use_roxygen_md</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="../reference/logical-expectations.html">expect_true</a></span><span class="op">(</span><span class="fu">uses_roxygen_md</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">desc</span><span class="fu">::</span><span class="fu"><a href="https://desc.r-lib.org/reference/desc_get.html" class="external-link">desc_get</a></span><span class="op">(</span><span class="st">"Roxygen"</span>, <span class="va">pkg</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">"list(markdown = TRUE)"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/logical-expectations.html">expect_true</a></span><span class="op">(</span><span class="fu">desc</span><span class="fu">::</span><span class="fu"><a href="https://desc.r-lib.org/reference/desc_has_fields.html" class="external-link">desc_has_fields</a></span><span class="op">(</span><span class="st">"RoxygenNote"</span>, <span class="va">pkg</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="scope">Scope<a class="anchor" aria-label="anchor" href="#scope"></a>
</h2>
<p>So far we have applied our test fixture to individual tests, but it‚Äôs
also possible to apply them to a file or package.</p>
<div class="section level3">
<h3 id="file">File<a class="anchor" aria-label="anchor" href="#file"></a>
</h3>
<p>If you move the <code>local_*()</code> call outside of a
<code><a href="../reference/test_that.html">test_that()</a></code> block, it will affect all tests that come after
it. This means that by calling the test fixture at the top of the file,
you can change the behavior for all tests. This has both advantages and
disadvantages:</p>
<ul>
<li><p>If you would otherwise have called the fixture in every test,
you‚Äôve saved yourself a bunch of work and duplicate code.</p></li>
<li><p>On the downside, if your test fails and you want to recreate the
failure in an interactive environment so you can debug, you need to
remember to run all the setup code at the top of the file
first.</p></li>
</ul>
<p>Generally, I think it‚Äôs better to copy and paste test fixtures across
many tests ‚Äî sure, it adds some duplication to your code, but it makes
debugging test failures so much easier.</p>
</div>
<div class="section level3">
<h3 id="package">Package<a class="anchor" aria-label="anchor" href="#package"></a>
</h3>
<p>To run code before any test is run, you can create a file called
<code>tests/testthat/setup.R</code>. If the code in this file needs
clean up, you can use the special <code><a href="../reference/teardown_env.html">teardown_env()</a></code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run before any test</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="st">"mtcars.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run after all tests</span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="st">"mtcars.csv"</span><span class="op">)</span>, <span class="fu"><a href="../reference/teardown_env.html">teardown_env</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Setup code is typically best used to create external resources that
are needed by many tests. It‚Äôs best kept to a minimum because you will
have to manually run it before interactively debugging tests.</p>
</div>
</div>
<div class="section level2">
<h2 id="other-challenges">Other challenges<a class="anchor" aria-label="anchor" href="#other-challenges"></a>
</h2>
<p>A collection of miscellaneous problems that don‚Äôt fit elsewhere:</p>
<ul>
<li><p>There are a few base functions that are hard to test because they
depend on state that you can‚Äôt control. One such example is
<code><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive()</a></code>: there‚Äôs no way to write a test fixture that
allows you to pretend that interactive is either <code>TRUE</code> or
<code>FALSE</code>. So we now usually use
<code><a href="https://rlang.r-lib.org/reference/is_interactive.html" class="external-link">rlang::is_interactive()</a></code>, which can be controlled by the
<code>rlang_interactive</code> option.</p></li>
<li><p>If you‚Äôre using a test fixture in a function, be careful about
what you return. For example, if you write a function that does
<code>dir &lt;- create_local_package()</code>, you shouldn‚Äôt return
<code>dir</code>, because after the function returns, the directory will
no longer exist.</p></li>
</ul>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer>
</body>
</html>
