<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Mocking tools — local_mocked_bindings • testthat</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mocking tools — local_mocked_bindings"><meta name="description" content="with_mocked_bindings() and local_mocked_bindings() provide tools for
&quot;mocking&quot;, temporarily redefining a function so that it behaves differently
during tests. This is helpful for testing functions that depend on external
state (i.e. reading a value from a file or a website, or pretending a package
is or isn't installed).
These functions represent a second attempt at bringing mocking to testthat,
incorporating what we've learned from the mockr, mockery, and mockthat
packages."><meta property="og:description" content="with_mocked_bindings() and local_mocked_bindings() provide tools for
&quot;mocking&quot;, temporarily redefining a function so that it behaves differently
during tests. This is helpful for testing functions that depend on external
state (i.e. reading a value from a file or a website, or pretending a package
is or isn't installed).
These functions represent a second attempt at bringing mocking to testthat,
incorporating what we've learned from the mockr, mockery, and mockthat
packages."><meta property="og:image" content="https://testthat.r-lib.org/logo.png"><meta name="robots" content="noindex"><script defer data-domain="testthat.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">testthat</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">3.2.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/custom-expectation.html">Custom expectations</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Running tests in parallel</a></li>
    <li><a class="dropdown-item" href="../articles/skipping.html">Skipping tests</a></li>
    <li><a class="dropdown-item" href="../articles/snapshotting.html">Snapshot tests</a></li>
    <li><a class="dropdown-item" href="../articles/special-files.html">Special files</a></li>
    <li><a class="dropdown-item" href="../articles/test-fixtures.html">Test fixtures</a></li>
    <li><a class="dropdown-item" href="../articles/third-edition.html">testthat 3e</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news"><li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/10/testthat-3-2-0/">Version 3.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/10/testthat-3-1/">Version 3.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/10/testthat-3-0-0/">Version 3.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/testthat/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Mocking tools</h1>
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/main/R/mock2.R" class="external-link"><code>R/mock2.R</code></a></small>
      <div class="d-none name"><code>local_mocked_bindings.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>with_mocked_bindings()</code> and <code>local_mocked_bindings()</code> provide tools for
"mocking", temporarily redefining a function so that it behaves differently
during tests. This is helpful for testing functions that depend on external
state (i.e. reading a value from a file or a website, or pretending a package
is or isn't installed).</p>
<p>These functions represent a second attempt at bringing mocking to testthat,
incorporating what we've learned from the mockr, mockery, and mockthat
packages.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">local_mocked_bindings</span><span class="op">(</span><span class="va">...</span>, .package <span class="op">=</span> <span class="cn">NULL</span>, .env <span class="op">=</span> <span class="fu">caller_env</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">with_mocked_bindings</span><span class="op">(</span><span class="va">code</span>, <span class="va">...</span>, .package <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Name-value pairs providing new values (typically functions) to
temporarily replace the named bindings.</p></dd>


<dt id="arg--package">.package<a class="anchor" aria-label="anchor" href="#arg--package"></a></dt>
<dd><p>The name of the package where mocked functions should be
inserted. Generally, you should not supply this as it will be automatically
detected when whole package tests are run or when there's one package
under active development (i.e. loaded with <code><a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link">pkgload::load_all()</a></code>).
We don't recommend using this to mock functions in other packages,
as you should not modify namespaces that you don't own.</p></dd>


<dt id="arg--env">.env<a class="anchor" aria-label="anchor" href="#arg--env"></a></dt>
<dd><p>Environment that defines effect scope. For expert use only.</p></dd>


<dt id="arg-code">code<a class="anchor" aria-label="anchor" href="#arg-code"></a></dt>
<dd><p>Code to execute with specified bindings.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="use">Use<a class="anchor" aria-label="anchor" href="#use"></a></h2>
    <p>There are four places that the function you are trying to mock might
come from:</p><ul><li><p>Internal to your package.</p></li>
<li><p>Imported from an external package via the <code>NAMESPACE</code>.</p></li>
<li><p>The base environment.</p></li>
<li><p>Called from an external package with <code>::</code>.</p></li>
</ul><p>They are described in turn below.</p><div class="section">
<h3 id="internal-amp-imported-functions">Internal &amp; imported functions<a class="anchor" aria-label="anchor" href="#internal-amp-imported-functions"></a></h3>


<p>You mock internal and imported functions the same way. For example, take
this code:</p>
<p></p><div class="sourceCode R"><pre><code><span><span class="va">some_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">another_function</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre><p></p></div>
<p>It doesn't matter whether <code>another_function()</code> is defined by your package
or you've imported it from a dependency with <code>@import</code> or <code>@importFrom</code>,
you mock it the same way:</p>
<p></p><div class="sourceCode R"><pre><code><span><span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span></span>
<span>  another_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="st">"new_value"</span></span>
<span><span class="op">)</span></span></code></pre><p></p></div>
</div>

<div class="section">
<h3 id="base-functions">Base functions<a class="anchor" aria-label="anchor" href="#base-functions"></a></h3>


<p>To mock a function in the base package, you need to make sure that you
have a binding for this function in your package. It's easiest to do this
by binding the value to <code>NULL</code>. For example, if you wanted to mock
<code><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive()</a></code> in your package, you'd need to include this code somewhere
in your package:</p>
<p></p><div class="sourceCode R"><pre><code><span><span class="va">interactive</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre><p></p></div>
<p>Why is this necessary? <code>with_mocked_bindings()</code> and <code>local_mocked_bindings()</code>
work by temporarily modifying the bindings within your package's namespace.
When these tests are running inside of <code>R CMD check</code> the namespace is locked
which means it's not possible to create new bindings so you need to make sure
that the binding exists already.</p>
</div>

<div class="section">
<h3 id="namespaced-calls">Namespaced calls<a class="anchor" aria-label="anchor" href="#namespaced-calls"></a></h3>


<p>It's trickier to mock functions in other packages that you call with <code>::</code>.
For example, take this minor variation:</p>
<p></p><div class="sourceCode R"><pre><code><span><span class="va">some_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">anotherpackage</span><span class="fu">::</span><span class="fu">another_function</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre><p></p></div>
<p>To mock this function, you'd need to modify <code>another_function()</code> inside the
<code>anotherpackage</code> package. You <em>can</em> do this by supplying the <code>.package</code>
argument to <code>local_mocked_bindings()</code> but we don't recommend it because
it will affect all calls to <code>anotherpackage::another_function()</code>, not just
the calls originating in your package. Instead, it's safer to either import
the function into your package, or make a wrapper that you can mock:</p>
<p></p><div class="sourceCode R"><pre><code><span><span class="va">some_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">my_wrapper</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">my_wrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">anotherpackage</span><span class="fu">::</span><span class="fu">another_function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span></span>
<span>  my_wrapper <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="st">"new_value"</span></span>
<span><span class="op">)</span></span></code></pre><p></p></div>
</div>

<div class="section">
<h3 id="multiple-return-values-sequence-of-outputs">Multiple return values / sequence of outputs<a class="anchor" aria-label="anchor" href="#multiple-return-values-sequence-of-outputs"></a></h3>


<p>To mock a function that returns different values in sequence,
for instance an API call whose status would be 502 then 200,
or an user intput to <code><a href="https://rdrr.io/r/base/readline.html" class="external-link">readline()</a></code>, you can use <code><a href="mock_output_sequence.html">mock_output_sequence()</a></code></p>
<p></p><div class="sourceCode R"><pre><code><span><span class="fu"><a href="../reference/local_mocked_bindings.html">local_mocked_bindings</a></span><span class="op">(</span>readline <span class="op">=</span> <span class="fu"><a href="../reference/mock_output_sequence.html">mock_output_sequence</a></span><span class="op">(</span><span class="st">"3"</span>, <span class="st">"This is a note"</span>, <span class="st">"n"</span><span class="op">)</span><span class="op">)</span></span></code></pre><p></p></div>
</div>

    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>Other mocking:
<code><a href="mock_output_sequence.html">mock_output_sequence</a>()</code></p></div>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer></body></html>

